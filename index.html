<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-list Diário - LEFE</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTEVGRSBDaGVjay1saXN0Iiwic2hvcnRfbmFtZSI6IkxFRkUiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2Q5MDAwMCIsInRoZW1lX2NvbG9yIjoiI2Q5MDAwMCIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBME9EQWdORGd3SWo0OGNtVmpkQ0IzYVdSMGFEMGlORGd3SWlCb1pXbG5hSFE5SWpRNE1DSWdabWxzYkQwaVkyUmxObmxoSWk4K1BDOXRKVE0rIiwic2l6ZXMiOiI0ODB4NDgwIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">
    <style>
        :root {
            --primary-color: #d90000;
            --primary-dark: #b80000;
            --secondary-color: #0056b3;
            --secondary-dark: #004494;
            --light-gray: #f4f4f4;
            --medium-gray: #ccc;
            --dark-gray: #333;
            --success: #4CAF50;
            --warning: #ff9800;
            --danger: #f44336;
            --background: #ffffff;
            --text: #333333;
            --card-bg: #ffffff;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --light-gray: #2a2a2a;
                --medium-gray: #555;
                --dark-gray: #ffffff;
                --background: #1a1a1a;
                --text: #ffffff;
                --card-bg: #2d2d2d;
            }
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: var(--light-gray);
            color: var(--text);
            margin: 5px;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }
        h1 {
            font-size: 24px;
            text-align: center;
        }
        h2 {
            font-size: 18px;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 8px;
            border: 1px solid var(--medium-gray);
            text-align: left;
        }
        th {
            background-color: var(--light-gray);
        }
        input[type="text"], input[type="date"], input[type="time"], input[type="number"], select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            box-sizing: border-box;
            background-color: var(--card-bg);
            color: var(--text);
        }
        td input, td select {
            width: auto;
        }
        .signature {
            margin-top: 15px;
        }
        .footer {
            margin-top: 15px;
            font-size: 12px;
            text-align: center;
            color: #666;
        }
        
        /* Toolbar e botões */
        .toolbar {
            position: sticky;
            top: 0;
            z-index: 999;
            background: var(--light-gray);
            padding: 10px 0;
            max-width: 900px;
            margin: 0 auto 5px;
            text-align: right;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-end;
            border-radius: 5px;
        }
        .toolbar button {
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.10);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-print { background: var(--primary-color); }
        .btn-print:hover { background: var(--primary-dark); }
        .btn-email { background: var(--secondary-color); }
        .btn-email:hover { background: var(--secondary-dark); }
        .btn-save { background: var(--success); }
        .btn-save:hover { background: #3d8b40; }
        .btn-clear { background: var(--danger); }
        .btn-clear:hover { background: #c62828; }
        .btn-export { background: #673AB7; }
        .btn-export:hover { background: #5E35B1; }
        .btn-history { background: #795548; }
        .btn-history:hover { background: #6D4C41; }
        .btn-qr { background: #FF5722; }
        .btn-qr:hover { background: #E64A19; }
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            max-width: 300px;
            font-size: 16px;
        }
        .notification.success { background: var(--success); color: white; }
        .notification.error { background: var(--danger); color: white; }
        .notification.warning { background: var(--warning); color: white; }
        .notification.info { background: var(--secondary-color); color: white; }
        .required-field {
            border: 2px solid var(--primary-color) !important;
            background-color: #fff2f2;
        }
        
        /* Status counters */
        .status-counters {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            flex-wrap: wrap;
            gap: 10px;
        }
        .status-counter {
            padding: 10px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            text-align: center;
            min-width: 120px;
        }
        .status-ok { background-color: var(--success); }
        .status-ruim { background-color: var(--warning); }
        .status-quebrado { background-color: #ff5722; }
        .status-faltando { background-color: #9c27b0; }
        .status-parar { background-color: var(--danger); }
        
        .critical-item {
            background-color: #fff2f2 !important;
            font-weight: bold;
        }
        
        .item-highlight {
            animation: highlight 2s ease;
            background-color: #ffffd0;
        }
        
        @keyframes highlight {
            0% { background-color: #ffffd0; }
            100% { background-color: transparent; }
        }
        
        .save-indicator {
            font-size: 12px;
            color: #666;
            margin-left: 10px;
            font-style: italic;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: var(--text); }
        
        /* Modal de boas-vindas */
        .welcome-modal .modal-content {
            max-width: 800px;
        }
        .welcome-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .welcome-header h1 {
            font-size: 28px;
            color: var(--primary-color);
            border: none;
        }
        .welcome-section {
            margin-bottom: 20px;
        }
        .welcome-section h2 {
            font-size: 20px;
            margin-top: 15px;
            margin-bottom: 10px;
        }
        .welcome-section ul {
            padding-left: 20px;
        }
        .welcome-section li {
            margin-bottom: 8px;
        }
        .welcome-footer {
            text-align: center;
            margin-top: 25px;
        }
        .btn-welcome {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }
        .btn-welcome:hover {
            background: var(--primary-dark);
        }
        
        /* Assinatura digital */
        #assinaturaCanvas {
            border: 2px solid var(--medium-gray);
            border-radius: 5px;
            cursor: crosshair;
            background-color: white;
        }
        /* Upload de fotos */
        .photo-upload {
            margin: 10px 0;
        }
        .photo-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 5px;
            border-radius: 5px;
        }
        /* QR Code */
        #qrcode {
            text-align: center;
            margin: 20px 0;
        }
        /* Histórico */
        .history-item {
            padding: 10px;
            border: 1px solid var(--medium-gray);
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            background-color: var(--light-gray);
        }
        .history-item:hover {
            background-color: var(--medium-gray);
        }
        /* Localização */
        .location-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .mobile-optimized select, .mobile-optimized input[type="text"] {
            font-size: 16px;
        }
        
        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            .toolbar button {
                width: 100%;
                justify-content: center;
            }
            .status-counters {
                flex-direction: column;
            }
            .modal-content {
                width: 95%;
                margin: 2% auto;
            }
            .welcome-modal .modal-content {
                width: 95%;
                padding: 15px;
            }
            .welcome-header h1 {
                font-size: 24px;
            }
            .welcome-section h2 {
                font-size: 18px;
            }
        }
        
        @media print {
            .no-print, .no-print * {
                display: none !important;
            }
            body, .container {
                margin: 0;
                padding: 0;
                box-shadow: none;
                border-radius: 0;
            }
            .status-counters {
                display: none;
            }
        }
        /* Dashboard básico */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .dashboard-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary-color);
        }
        .dashboard-card h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Modal de Boas-vindas -->
    <div id="welcomeModal" class="modal welcome-modal">
        <div class="modal-content">
            <div class="welcome-header">
                <h1>🏥 Check-list Diário - LEFE</h1>
                <p>🚨 Este é um aplicativo web completo para check-list diário de inspeção veicular e equipamentos do Serviço de Emergências Médicas (LEFE). <br>A aplicação oferece uma interface intuitiva e responsiva para registrar o estado dos veículos de emergência.</p>
            </div>
            
            <div class="welcome-section">
                <h2>Funcionalidades Principais</h2>
                <h3>📝 Registro de Dados</h3>
                <ul>
                    <li>Informações básicas (hospital, data, horários, condutores)</li>
                    <li>Dados da viatura (placa, quilometragem, combustível, etc.)</li>
                    <li>Validação automática de placa brasileira (formatos antigo e novo)</li>
                </ul>
                
                <h3>✅ Check-list de Inspeção</h3>
                <ul>
                    <li>Lista completa de itens para inspeção (óleo, freio, pneus, etc.)</li>
                    <li>Status para cada item: OK, Ruim, Quebrado, Faltando, Parar VTR</li>
                    <li>Itens críticos destacados visualmente</li>
                    <li>Campos para observações e fotos para cada item</li>
                </ul>
                
                <h3>🛠️ Recursos Avançados</h3>
                <ul>
                    <li>Localização GPS: Obtém e armazena coordenadas geográficas</li>
                    <li>Assinatura digital: Canvas para assinatura digital</li>
                    <li>Upload de fotos: Possibilidade de anexar fotos aos itens</li>
                    <li>Armazenamento local: Salva dados no navegador</li>
                    <li>Histórico: Visualização e carregamento de check-lists anteriores</li>
                    <li>QR Code: Geração de QR Code para acesso rápido</li>
                </ul>
                
                <h3>📤 Exportação e Compartilhamento</h3>
                <ul>
                    <li>Exportação de dados: Exportação em formato JSON</li>
                    <li>Envio por e-mail: Gera e-mail formatado com os dados</li>
                    <li>Impressão: Layout otimizado para impressão</li>
                </ul>
                
                <h3>📱 Design Responsivo</h3>
                <ul>
                    <li>Layout adaptável para diferentes tamanhos de tela</li>
                    <li>Suporte para modo escuro/claro</li>
                    <li>Interface otimizada para dispositivos móveis</li>
                </ul>
            </div>
            
            <div class="welcome-section">
                <h2>🙋🏻 Como Utilizar</h2>
                <ol>
                    <li>Preencha os campos básicos (hospital, data, condutores)</li>
                    <li>Informe os dados da viatura (placa, quilometragem, etc.)</li>
                    <li>Selecione o status para cada item de inspeção</li>
                    <li>Adicione observações e fotos se necessário</li>
                    <li>Assine digitalmente o documento</li>
                    <li>Salve, exporte ou envie por e-mail os dados</li>
                </ol>
            </div>
            
            <div class="welcome-footer">
                <button class="btn-welcome" onclick="fecharBoasVindas()">Começar a usar o aplicativo</button>
            </div>
        </div>
    </div>
    
    <!-- Barra de ferramentas melhorada -->
    <div class="toolbar no-print">
        <button class="btn-print" onclick="window.print()"><span>🖨️</span> Imprimir</button>
        <button class="btn-email" onclick="enviarPorEmail()"><span>✉️</span> E-mail</button>
        <button class="btn-save" onclick="salvarDados()"><span>💾</span> Salvar</button>
        <button class="btn-export" onclick="exportarDados()"><span>📤</span> Exportar</button>
        <button class="btn-history" onclick="abrirHistorico()"><span>📋</span> Histórico</button>
        <button class="btn-qr" onclick="gerarQRCode()"><span>📱</span> QR Code</button>
        <button class="btn-clear" onclick="limparFormulario()"><span>🗑️</span> Limpar</button>
        <span id="saveIndicator" class="save-indicator"></span>
    </div>
    
    <div class="container">
        <h1>🚑 LEFE - SERVIÇO DE EMERGÊNCIAS MÉDICAS</h1>
        <h2>📋 CHECK-LIST DIÁRIO DE INSPEÇÃO VEICULAR E EQUIPAMENTOS</h2>
        
        <div class="status-counters no-print">
            <div class="status-counter status-ok">✅ OK: <span id="count-ok">0</span></div>
            <div class="status-counter status-ruim">⚠️ Ruim: <span id="count-ruim">0</span></div>
            <div class="status-counter status-quebrado">🛠️ Quebrado: <span id="count-quebrado">0</span></div>
            <div class="status-counter status-faltando">❌ Faltando: <span id="count-faltando">0</span></div>
            <div class="status-counter status-parar">🚨 Parar VTR: <span id="count-parar">0</span></div>
        </div>
        
        <table>
            <tr><td><strong>Hospital:</strong></td><td><input type="text" id="hospital" placeholder="Hospital Raimundo Lima"></td></tr>
            <tr><td><strong>Data:</strong></td><td><input type="date" id="data"></td></tr>
            <tr><td><strong>Horário de Entrada:</strong></td><td><input type="time" id="horarioEntrada" value="07:00"></td></tr>
            <tr><td><strong>Horário de Saída:</strong></td><td><input type="time" id="horarioSaida" value="19:00"></td></tr>
            <tr><td><strong>Condutor de Plantão:</strong></td><td><input type="text" id="condutorPlantao" placeholder="Nome completo"></td></tr>
            <tr><td><strong>Recebendo de:</strong></td><td><input type="text" id="recebendoDe" placeholder="Nome do condutor anterior"></td></tr>
        </table>
        
        <h2>🚑 DADOS DA VIATURA (USA)</h2>
        <table>
            <tr><th>Item</th><th>Informação</th></tr>
            <tr><td><strong>Placa</strong></td><td><input type="text" id="placa" placeholder="Ex: ABC1234 ou ABC1D23" onblur="validarPlaca()"></td></tr>
            <tr><td><strong>Km Atual</strong></td><td><input type="number" id="kmAtual" placeholder="Ex: 337847"></td></tr>
            <tr><td><strong>Nível de Combustível</strong></td><td><input type="text" id="nivelCombustivel" placeholder="Ex: 5/10 traços ou 1/2 tanque"></td></tr>
            <tr><td><strong>CRV Válido até</strong></td><td><input type="number" id="crvValido" placeholder="Ano (ex: 2024)"></td></tr>
            <tr><td><strong>Próxima Troca de Óleo km</strong></td><td><input type="number" id="proximaTrocaOleo" placeholder="Km da próxima troca"></td></tr>
            <tr>
                <td><strong>Cartão de Abastecimento</strong></td>
                <td>
                    <input type="radio" id="cartaoDisponivel" name="cartaoStatus" value="Disponível"> 
                    <label for="cartaoDisponivel">Disponível</label>
                    <input type="radio" id="cartaoNaoDisponivel" name="cartaoStatus" value="Não Disponível"> 
                    <label for="cartaoNaoDisponivel">Não Disponível</label>
                </td>
            </tr>
        </table>
        <!-- Localização -->
        <div id="localizacao" class="location-info no-print"></div>
        
        <h2>🛠️ STATUS DE INSPEÇÃO</h2>
        <p><em>Selecione o status: ✅ OK | ⚠️ Ruim | 🛠️ Quebrado | ❌ Faltando | 🚨 Parar VTR</em></p>
        <table id="inspection-table">
            <thead>
                <tr><th>#</th><th>Item</th><th>Status</th><th>Observação</th><th class="no-print">📷</th></tr>
            </thead>
            <tbody>
                <!-- Itens gerados via JS -->
            </tbody>
        </table>
        
        <h2>🛠️ OBSERVAÇÕES GERAIS / AVARIAS</h2>
        <textarea id="observacoesAvarias" rows="6" style="width: 100%;" placeholder="Digite suas observações aqui. Use Enter para quebrar linhas."></textarea>
        
        <!-- Upload de fotos gerais -->
        <div class="photo-upload no-print">
            <label for="fotosGerais"><strong>📷 Fotos Gerais (opcional):</strong></label>
            <input type="file" id="fotosGerais" accept="image/*" multiple capture="camera">
            <div id="previewFotosGerais"></div>
        </div>
        
        <h2>✍️ ASSINATURAS</h2>
        <div class="signature">
            <p><strong>Assinatura Digital do Condutor:</strong></p>
            <canvas id="assinaturaCanvas" width="400" height="150" class="no-print"></canvas>
            <br>
            <button onclick="limparAssinatura()" class="no-print">🗑️ Limpar Assinatura</button>
            <button onclick="salvarAssinatura()" class="no-print">💾 Salvar Assinatura</button>
            
            <!-- Para impressão -->
            <div id="assinaturaImpressa" style="display: none;">
                <img id="assinaturaImg" style="max-width: 400px; border: 1px solid #ccc;">
            </div>
            
            <p style="margin-top: 20px;"><strong>Condutor Recebendo o Plantão:</strong> _________________________________________</p>
            <p><strong>Condutor Entregando o Plantão:</strong> _________________________________________</p>
        </div>
        <div class="footer">
            <p>📝 Documento válido como registro de inspeção diária – LEFE<br>
            🗂️ Arquivar após preenchimento.<br>⏳ Atualizado em 2025.</p>
        </div>
    </div>
    
    <!-- Modal do Histórico -->
    <div id="modalHistorico" class="modal no-print">
        <div class="modal-content">
            <span class="close" onclick="fecharHistorico()">&times;</span>
            <h2>📋 Histórico de Check-lists</h2>
            <div id="listaHistorico"></div>
        </div>
    </div>
    <!-- Modal do QR Code -->
    <div id="modalQR" class="modal no-print">
        <div class="modal-content">
            <span class="close" onclick="fecharQRCode()">&times;</span>
            <h2>📱 QR Code - Acesso Rápido</h2>
            <div id="qrcode"></div>
            <p style="text-align: center;">Escaneie para acessar rapidamente este check-list</p>
        </div>
    </div>
    
    <!-- Notificação -->
    <div id="notification" class="notification"></div>
    
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <script>
        // Lista de itens com críticos
        const inspectionItems = [
            { name: "Óleo do motor", critical: true },
            { name: "Óleo hidráulico (caixa de direção)", critical: true },
            { name: "Fluido do radiador", critical: true },
            { name: "Fluido de freio", critical: true },
            { name: "Água do limpador de para-brisa", critical: false },
            { name: "Correia do alternador", critical: true },
            { name: "Correia dentada do motor", critical: true },
            { name: "Retrovisores", critical: true },
            { name: "Para-brisa", critical: true },
            { name: "Caixa de marchas", critical: true },
            { name: "Pisca dos retrovisores", critical: false },
            { name: "Faróis dianteiros", critical: true },
            { name: "Lanternas traseiras", critical: true },
            { name: "Buzina e pisca de alerta", critical: false },
            { name: "Botões dos vidros elétricos", critical: false },
            { name: "Travamento das portas", critical: true },
            { name: "Sinalizadores de emergência", critical: true },
            { name: "Sirene", critical: true },
            { name: "Luzes internas", critical: false },
            { name: "Farol de embarque", critical: false },
            { name: "Freio de estacionamento", critical: true },
            { name: "Pastilhas de freio (dianteira/traseira)", critical: true },
            { name: "Pneus", critical: true },
            { name: "Macaco, chave de roda, triângulo", critical: true },
            { name: "Limpadores/palhetas do para-brisa", critical: true },
            { name: "Limpeza interna", critical: false },
            { name: "Limpeza externa", critical: false },
            { name: "Ar condicionado (dianteiro)", critical: false },
            { name: "Ar condicionado (traseiro)", critical: false },
            { name: "Extintor de incêndio", critical: true },
            { name: "Alarme de estacionamento", critical: false },
            { name: "Alinhamento/Balanceamento", critical: false },
            { name: "Cilindro de oxigênio fixo (01)", critical: true },
            { name: "Cintos de segurança", critical: true },
            { name: "Maca e cinto de segurança", critical: true },
            { name: "Cadeira de rodas (se aplicável)", critical: false },
            { name: "Prancha/Escada", critical: false },
            { name: "Bateria, inversor, transformador", critical: true },
            { name: "Bancos e capas", critical: false },
            { name: "Pintura/Plotagem", critical: false },
            { name: "Câmera de ré (se aplicável)", critical: false },
            { name: "Chave de troca de oxigênio", critical: true },
            { name: "Bala de oxigênio portátil", critical: true },
            { name: "Desfibrilador", critical: true },
            { name: "Monitor", critical: true },
            { name: "Respirador", critical: true },
            { name: "Oxímetro", critical: true },
            { name: "Termômetro", critical: true },
            { name: "Glicosímetro", critical: true },
            { name: "Bolsa de medicação", critical: true },
            { name: "Bolsa de entubação", critical: true },
            { name: "Bolsa de ventilação", critical: true },
            { name: "Bolsa via aérea", critical: true },
            { name: "Armário do salão", critical: false },
            { name: "Gavetas do salão", critical: false },
            { name: "Baú do salão", critical: false },
            { name: "Painel de controle do salão", critical: true }
        ];
        let autoSaveInterval;
        let lastSaveTime = null;
        let assinaturaCanvas, assinaturaCtx;
        let desenhandoAssinatura = false;
        let coordenadasGPS = null;
        
        // Verificar se é a primeira visita e mostrar boas-vindas
        function verificarPrimeiraVisita() {
            const primeiraVisita = localStorage.getItem('lefePrimeiraVisita');
            if (!primeiraVisita) {
                document.getElementById('welcomeModal').style.display = 'block';
                localStorage.setItem('lefePrimeiraVisita', 'false');
            }
        }
        
        // Fechar modal de boas-vindas
        function fecharBoasVindas() {
            document.getElementById('welcomeModal').style.display = 'none';
        }
        
        // Validação de placa brasileira
        function validarPlaca() {
            const placaInput = document.getElementById("placa");
            const placa = placaInput.value.trim().toUpperCase();
            
            // Formatos: ABC-1234, ABC1234, ABC1D23
            const regexAntigo = /^[A-Z]{3}-?\d{4}$/;
            const regexNovo = /^[A-Z]{3}\d[A-Z]\d{2}$/;
            
            if (placa && !regexAntigo.test(placa) && !regexNovo.test(placa)) {
                placaInput.classList.add('required-field');
                showNotification("Formato de placa inválido. Use ABC1234 ou ABC1D23", "error");
                return false;
            } else {
                placaInput.classList.remove('required-field');
                // Formatar placa automaticamente
                if (regexAntigo.test(placa.replace('-', ''))) {
                    placaInput.value = placa.replace('-', '');
                }
                return true;
            }
        }
        // Gera chave única: placa + data
        function getStorageKey() {
            const placa = document.getElementById("placa").value.trim().toUpperCase();
            const data = document.getElementById("data").value;
            return placa && data ? `checklist_${placa}_${data}` : null;
        }
        // Obter localização GPS
        function obterLocalizacao() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        coordenadasGPS = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            timestamp: new Date().toISOString()
                        };
                        document.getElementById('localizacao').innerHTML = 
                            `📍 Localização: ${coordenadasGPS.latitude.toFixed(6)}, ${coordenadasGPS.longitude.toFixed(6)} (${new Date(coordenadasGPS.timestamp).toLocaleTimeString()})`;
                    },
                    function(error) {
                        console.log("Erro ao obter localização:", error);
                        document.getElementById('localizacao').innerHTML = '📍 Localização não disponível';
                    }
                );
            }
        }
        function generateInspectionTable() {
            const tableBody = document.querySelector("#inspection-table tbody");
            const statusOptions = `
                <option value=""></option>
                <option value="✅ OK">✅ OK</option>
                <option value="⚠️ Ruim">⚠️ Ruim</option>
                <option value="🛠️ Quebrado">🛠️ Quebrado</option>
                <option value="❌ Faltando">❌ Faltando</option>
                <option value="🚨 Parar VTR">🚨 Parar VTR</option>
            `;
            
            inspectionItems.forEach((item, index) => {
                const row = document.createElement('tr');
                if (item.critical) row.classList.add('critical-item');
                row.innerHTML = `
                    <td>${(index + 1).toString().padStart(2, '0')}</td>
                    <td>${item.name}</td>
                    <td><select id="status-${index + 1}" class="status-select">${statusOptions}</select></td>
                    <td><input type="text" id="obs-${index + 1}" class="obs-input" style="width: 100%;"></td>
                    <td class="no-print"><input type="file" id="foto-${index + 1}" accept="image/*" capture="camera" style="width: 60px; font-size: 12px;"></td>
                `;
                tableBody.appendChild(row);
            });
            document.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', updateStatusCounters);
            });
            document.querySelectorAll('.obs-input').forEach(input => {
                input.addEventListener('input', debounce(salvarDados, 1000));
            });
            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.addEventListener('change', handleFileUpload);
            });
        }
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Salvar foto na localStorage (limitado pelo tamanho)
                    try {
                        const fotoData = e.target.result;
                        localStorage.setItem(`foto_${event.target.id}`, fotoData);
                        showNotification("Foto salva com sucesso!", "success");
                    } catch (error) {
                        showNotification("Erro ao salvar foto (muito grande)", "error");
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        function updateStatusCounters() {
            const counters = { '✅ OK': 0, '⚠️ Ruim': 0, '🛠️ Quebrado': 0, '❌ Faltando': 0, '🚨 Parar VTR': 0 };
            document.querySelectorAll('.status-select').forEach(select => {
                if (select.value && counters[select.value] !== undefined) counters[select.value]++;
            });
            document.getElementById('count-ok').textContent = counters['✅ OK'];
            document.getElementById('count-ruim').textContent = counters['⚠️ Ruim'];
            document.getElementById('count-quebrado').textContent = counters['🛠️ Quebrado'];
            document.getElementById('count-faltando').textContent = counters['❌ Faltando'];
            document.getElementById('count-parar').textContent = counters['🚨 Parar VTR'];
        }
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        function salvarDados() {
            try {
                const key = getStorageKey();
                if (!key) return false;
                const dados = {
                    hospital: document.getElementById("hospital").value,
                    data: document.getElementById("data").value,
                    horarioEntrada: document.getElementById("horarioEntrada").value,
                    horarioSaida: document.getElementById("horarioSaida").value,
                    condutorPlantao: document.getElementById("condutorPlantao").value,
                    recebendoDe: document.getElementById("recebendoDe").value,
                    placa: document.getElementById("placa").value,
                    kmAtual: document.getElementById("kmAtual").value,
                    nivelCombustivel: document.getElementById("nivelCombustivel").value,
                    crvValido: document.getElementById("crvValido").value,
                    proximaTrocaOleo: document.getElementById("proximaTrocaOleo").value,
                    cartaoStatus: document.querySelector('input[name="cartaoStatus"]:checked')?.value || '',
                    observacoesAvarias: document.getElementById("observacoesAvarias").value,
                    coordenadasGPS: coordenadasGPS,
                    timestamp: new Date().toISOString(),
                    itens: []
                };
                for (let i = 1; i <= inspectionItems.length; i++) {
                    dados.itens.push({
                        status: document.getElementById(`status-${i}`).value,
                        obs: document.getElementById(`obs-${i}`).value
                    });
                }
                localStorage.setItem(key, JSON.stringify(dados));
                lastSaveTime = new Date();
                document.getElementById('saveIndicator').textContent = `Salvo: ${lastSaveTime.toLocaleTimeString()}`;
                showNotification("Salvo localmente.", "success");
                return true;
            } catch (e) {
                console.error("Erro ao salvar:", e);
                showNotification("Falha ao salvar.", "error");
                return false;
            }
        }
        function carregarDados() {
            try {
                const key = getStorageKey();
                if (!key) return false;
                const dadosSalvos = localStorage.getItem(key);
                if (!dadosSalvos) return false;
                const dados = JSON.parse(dadosSalvos);
                document.getElementById("hospital").value = dados.hospital || '';
                document.getElementById("data").value = dados.data || '';
                document.getElementById("horarioEntrada").value = dados.horarioEntrada || '';
                document.getElementById("horarioSaida").value = dados.horarioSaida || '';
                document.getElementById("condutorPlantao").value = dados.condutorPlantao || '';
                document.getElementById("recebendoDe").value = dados.recebendoDe || '';
                document.getElementById("placa").value = dados.placa || '';
                document.getElementById("kmAtual").value = dados.kmAtual || '';
                document.getElementById("nivelCombustivel").value = dados.nivelCombustivel || '';
                document.getElementById("crvValido").value = dados.crvValido || '';
                document.getElementById("proximaTrocaOleo").value = dados.proximaTrocaOleo || '';
                document.getElementById("observacoesAvarias").value = dados.observacoesAvarias || '';
                if (dados.cartaoStatus) {
                    const radio = document.querySelector(`input[name="cartaoStatus"][value="${dados.cartaoStatus}"]`);
                    if (radio) radio.checked = true;
                }
                if (dados.coordenadasGPS) {
                    coordenadasGPS = dados.coordenadasGPS;
                    document.getElementById('localizacao').innerHTML = 
                        `📍 Localização: ${dados.coordenadasGPS.latitude.toFixed(6)}, ${dados.coordenadasGPS.longitude.toFixed(6)} (${new Date(dados.coordenadasGPS.timestamp).toLocaleTimeString()})`;
                }
                if (dados.itens && dados.itens.length === inspectionItems.length) {
                    for (let i = 0; i < dados.itens.length; i++) {
                        document.getElementById(`status-${i+1}`).value = dados.itens[i].status || '';
                        document.getElementById(`obs-${i+1}`).value = dados.itens[i].obs || '';
                    }
                }
                updateStatusCounters();
                return true;
            } catch (e) {
                console.error("Erro ao carregar:", e);
                return false;
            }
        }
        // Exportar dados
        function exportarDados() {
            if (!validateForm()) return;
            const key = getStorageKey();
            if (!key) {
                showNotification("Preencha placa e data para exportar", "error");
                return;
            }
            const dados = localStorage.getItem(key);
            if (!dados) {
                showNotification("Nenhum dado para exportar", "error");
                return;
            }
            const blob = new Blob([dados], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${key}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification("Dados exportados com sucesso!", "success");
        }
        // Histórico
        function abrirHistorico() {
            const modal = document.getElementById('modalHistorico');
            const lista = document.getElementById('listaHistorico');
            lista.innerHTML = '';
            const historico = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('checklist_')) {
                    try {
                        const dados = JSON.parse(localStorage.getItem(key));
                        historico.push({ key, dados });
                    } catch (e) {
                        console.error('Erro ao carregar histórico:', e);
                    }
                }
            }
            historico.sort((a, b) => new Date(b.dados.timestamp || 0) - new Date(a.dados.timestamp || 0));
            if (historico.length === 0) {
                lista.innerHTML = '<p>Nenhum check-list encontrado no histórico.</p>';
            } else {
                historico.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.innerHTML = `
                        <strong>Placa:</strong> ${item.dados.placa}<br>
                        <strong>Data:</strong> ${item.dados.data}<br>
                        <strong>Condutor:</strong> ${item.dados.condutorPlantao}<br>
                        <small>Salvo em: ${new Date(item.dados.timestamp || 0).toLocaleString()}</small>
                    `;
                    div.onclick = () => carregarDoHistorico(item.key);
                    lista.appendChild(div);
                });
            }
            modal.style.display = 'block';
        }
        function carregarDoHistorico(key) {
            try {
                const dados = JSON.parse(localStorage.getItem(key));
                
                // Carregar todos os campos
                Object.keys(dados).forEach(campo => {
                    const elemento = document.getElementById(campo);
                    if (elemento && campo !== 'itens' && campo !== 'coordenadasGPS') {
                        elemento.value = dados[campo];
                    }
                });
                // Carregar itens
                if (dados.itens) {
                    dados.itens.forEach((item, index) => {
                        const statusEl = document.getElementById(`status-${index+1}`);
                        const obsEl = document.getElementById(`obs-${index+1}`);
                        if (statusEl) statusEl.value = item.status || '';
                        if (obsEl) obsEl.value = item.obs || '';
                    });
                }
                // Carregar coordenadas
                if (dados.coordenadasGPS) {
                    coordenadasGPS = dados.coordenadasGPS;
                    document.getElementById('localizacao').innerHTML = 
                        `📍 Localização: ${dados.coordenadasGPS.latitude.toFixed(6)}, ${dados.coordenadasGPS.longitude.toFixed(6)} (${new Date(dados.coordenadasGPS.timestamp).toLocaleTimeString()})`;
                }
                updateStatusCounters();
                fecharHistorico();
                showNotification("Check-list carregado do histórico!", "success");
            } catch (e) {
                showNotification("Erro ao carregar do histórico", "error");
            }
        }
        function fecharHistorico() {
            document.getElementById('modalHistorico').style.display = 'none';
        }
        // QR Code
        function gerarQRCode() {
            const placa = document.getElementById("placa").value.trim();
            const data = document.getElementById("data").value;
            
            if (!placa || !data) {
                showNotification("Preencha placa e data para gerar QR Code", "error");
                return;
            }
            const url = `${window.location.href.split('?')[0]}?placa=${encodeURIComponent(placa)}&data=${data}`;
            
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            
            QRCode.toCanvas(qrContainer, url, { width: 256 }, function (error) {
                if (error) {
                    showNotification("Erro ao gerar QR Code", "error");
                } else {
                    document.getElementById('modalQR').style.display = 'block';
                }
            });
        }
        function fecharQRCode() {
            document.getElementById('modalQR').style.display = 'none';
        }
        // Assinatura digital
        function initAssinatura() {
            assinaturaCanvas = document.getElementById('assinaturaCanvas');
            assinaturaCtx = assinaturaCanvas.getContext('2d');
            
            assinaturaCanvas.addEventListener('mousedown', startDrawing);
            assinaturaCanvas.addEventListener('mousemove', draw);
            assinaturaCanvas.addEventListener('mouseup', stopDrawing);
            assinaturaCanvas.addEventListener('touchstart', startDrawing);
            assinaturaCanvas.addEventListener('touchmove', draw);
            assinaturaCanvas.addEventListener('touchend', stopDrawing);
        }
        function startDrawing(e) {
            desenhandoAssinatura = true;
            draw(e);
        }
        function draw(e) {
            if (!desenhandoAssinatura) return;
            
            const rect = assinaturaCanvas.getBoundingClientRect();
            const x = (e.clientX || e.touches[0].clientX) - rect.left;
            const y = (e.clientY || e.touches[0].clientY) - rect.top;
            
            assinaturaCtx.lineWidth = 2;
            assinaturaCtx.lineCap = 'round';
            assinaturaCtx.strokeStyle = '#000';
            
            assinaturaCtx.lineTo(x, y);
            assinaturaCtx.stroke();
            assinaturaCtx.beginPath();
            assinaturaCtx.moveTo(x, y);
            
            e.preventDefault();
        }
        function stopDrawing() {
            if (desenhandoAssinatura) {
                desenhandoAssinatura = false;
                assinaturaCtx.beginPath();
            }
        }
        function limparAssinatura() {
            assinaturaCtx.clearRect(0, 0, assinaturaCanvas.width, assinaturaCanvas.height);
        }
        function salvarAssinatura() {
            const assinaturaDataURL = assinaturaCanvas.toDataURL();
            const key = getStorageKey();
            if (key) {
                localStorage.setItem(`${key}_assinatura`, assinaturaDataURL);
                showNotification("Assinatura salva!", "success");
            }
        }
        function validateForm() {
            const required = ["hospital", "data", "condutorPlantao", "placa", "kmAtual"];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dataInput = document.getElementById("data").value;
            const dataCheck = new Date(dataInput);
            dataCheck.setHours(0, 0, 0, 0);
            if (dataCheck > today) {
                showNotification("A data não pode ser futura.", "error");
                return false;
            }
            if (!validarPlaca()) {
                return false;
            }
            let isValid = true;
            document.querySelectorAll('.required-field').forEach(el => el.classList.remove('required-field'));
            required.forEach(id => {
                const el = document.getElementById(id);
                if (!el.value.trim()) {
                    isValid = false;
                    el.classList.add("required-field");
                }
            });
            const criticalIssues = [];
            inspectionItems.forEach((item, index) => {
                if (item.critical) {
                    const status = document.getElementById(`status-${index+1}`).value;
                    if (status && status !== "✅ OK") {
                        criticalIssues.push(item.name);
                    }
                }
            });
            if (criticalIssues.length > 0) {
                showNotification(`❗ Itens críticos com problemas: ${criticalIssues.slice(0, 3).join(", ")}${criticalIssues.length > 3 ? "..." : ""}`, "warning");
            }
            if (!isValid) {
                showNotification("Preencha os campos obrigatórios.", "error");
            }
            return isValid;
        }
        function enviarPorEmail() {
            if (!validateForm()) return;
            const dataValue = document.getElementById("data").value;
            const [y, m, d] = dataValue.split('-');
            const dataFormatada = `${d}/${m}/${y}`;
            const dadosCabecalho = {
                hospital: document.getElementById("hospital").value,
                data: dataFormatada,
                horarioEntrada: document.getElementById("horarioEntrada").value,
                horarioSaida: document.getElementById("horarioSaida").value,
                condutorPlantao: document.getElementById("condutorPlantao").value,
                recebendoDe: document.getElementById("recebendoDe").value
            };
            const dadosViatura = {
                placa: document.getElementById("placa").value.toUpperCase(),
                kmAtual: document.getElementById("kmAtual").value,
                nivelCombustivel: document.getElementById("nivelCombustivel").value,
                crvValido: document.getElementById("crvValido").value,
                proximaTrocaOleo: document.getElementById("proximaTrocaOleo").value,
                cartaoStatus: document.querySelector('input[name="cartaoStatus"]:checked')?.value || 'Não informado'
            };
            const itensInspecao = [];
            for (let i = 1; i <= inspectionItems.length; i++) {
                const status = document.getElementById(`status-${i}`).value;
                const obs = document.getElementById(`obs-${i}`).value.trim();
                if (status || obs) {
                    itensInspecao.push({
                        num: i.toString().padStart(2, '0'),
                        item: inspectionItems[i-1].name,
                        status: status || 'Não avaliado',
                        obs: obs || '---'
                    });
                }
            }
            if (itensInspecao.length === 0) {
                showNotification("Preencha ao menos um item de inspeção.", "warning");
                return;
            }
            const observacoesGerais = document.getElementById("observacoesAvarias").value;
            const localizacaoInfo = coordenadasGPS ? 
                `LOCALIZAÇÃO: ${coordenadasGPS.latitude.toFixed(6)}, ${coordenadasGPS.longitude.toFixed(6)}` : 
                'Localização não disponível';
            let corpoEmail = `
Check-list Diário v2.0 - Viatura ${dadosViatura.placa}
================================================
HOSPITAL: ${dadosCabecalho.hospital}
CONDUTOR DE PLANTÃO: ${dadosCabecalho.condutorPlantao}
DATA: ${dadosCabecalho.data}
HORÁRIO DE ENTRADA: ${dadosCabecalho.horarioEntrada}
HORÁRIO DE SAÍDA: ${dadosCabecalho.horarioSaida}
${localizacaoInfo}
--- DADOS DA VIATURA ---
Placa: ${dadosViatura.placa}
Km Atual: ${dadosViatura.kmAtual} km
Nível de Combustível: ${dadosViatura.nivelCombustivel}
Cartão de Abastecimento: ${dadosViatura.cartaoStatus}
--- ITENS DE INSPEÇÃO ---
${itensInspecao.map(i => `${i.num}. ${i.item}
   Status: ${i.status}
   Obs: ${i.obs}`).join('\n\n')}
${observacoesGerais ? `OBSERVAÇÕES GERAIS:\n${observacoesGerais}` : ''}
E-mail gerado automaticamente pelo sistema LEFE.
            `.trim();
            const assunto = `Check-list Viatura ${dadosViatura.placa} - ${dadosCabecalho.data}`;
            const destinatario = "manutencao@lefe.org.br";
            const mailtoLink = `mailto:${destinatario}?subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpoEmail)}`;
            window.location.href = mailtoLink;
            showNotification("Abrindo e-mail...", "success");
        }
        function limparFormulario() {
            if (confirm("Deseja realmente limpar todos os campos?")) {
                const key = getStorageKey();
                if (key) {
                    localStorage.removeItem(key);
                    localStorage.removeItem(`${key}_assinatura`);
                }
                location.reload();
            }
        }
        function showNotification(message, type) {
            const notification = document.getElementById("notification");
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = "block";
            setTimeout(() => notification.style.display = "none", 6000);
        }
        // Carregar parâmetros da URL (QR Code)
        function carregarParametrosURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const placa = urlParams.get('placa');
            const data = urlParams.get('data');
            
            if (placa) document.getElementById('placa').value = placa;
            if (data) document.getElementById('data').value = data;
            
            if (placa && data) {
                carregarDados();
                showNotification("Check-list carregado via QR Code!", "info");
            }
        }
        // Service Worker para PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,Y29uc3QgQ0FDSEVFX05BTUUgPSAnbGVmZS1jaGVja2xpc3QtdjEuMCc7DQpjb25zdCB1cmxzVG9DYWNoZSA9IFsNCiAgJy8nLA0KICAnL2luZGV4Lmh0bWwnDQpdOw0KDQpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2luc3RhbGwnLCBldmVudCA9PiB7DQogIGV2ZW50LndhaXRVbnRpbCgNCiAgICBjYWNoZXMub3BlbihDQUNIRV9OQU1FKQ0KICAgICAgLnRoZW4oY2FjaGUgPT4gY2FjaGUuYWRkQWxsKHVybHNUb0NhY2hlKSkNCiAgKTsNCn0pOw0KDQpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2ZldGNoJywgZXZlbnQgPT4gew0KICBldmVudC5yZXNwb25kV2l0aCgNCiAgICBjYWNoZXMubWF0Y2goZXZlbnQucmVxdWVzdCkNCiAgICAgIC50aGVuKHJlc3BvbnNlID0+IHJlc3BvbnNlIHx8IGZldGNoKGV2ZW50LnJlcXVlc3QpKQ0KICA7DQp9KTs=');
        }
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar primeira visita e mostrar boas-vindas
            verificarPrimeiraVisita();
            
            document.getElementById("data").value = new Date().toISOString().split("T")[0];
            generateInspectionTable();
            initAssinatura();
            carregarParametrosURL();
            obterLocalizacao();
            carregarDados();
            
            autoSaveInterval = setInterval(salvarDados, 30000);
            window.addEventListener('beforeunload', salvarDados);
            // Event listeners
            document.getElementById("placa").addEventListener("change", carregarDados);
            document.getElementById("data").addEventListener("change", carregarDados);
            
            // Fechar modais clicando fora
            window.onclick = function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            };
        });
    </script>
</body>
</html>
