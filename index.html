<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Mantém seu ícone de atalho -->
    <link rel="shortcut icon" type="image/png" href="icons/icon-192.png">
    <!-- Ícone para iPhone/iPad -->
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-list Diário - LEFE</title>
    
    <!-- Manifesto para PWA -->
    <link rel="manifest" href="manifest.json">
    <!-- Cor predominante do app -->
    <meta name="theme-color" content="#d90000">
    <style>
        :root {
            --primary-color: #d90000;
            --primary-dark: #b80000;
            --secondary-color: #0056b3;
            --secondary-dark: #004494;
            --light-gray: #f4f4f4;
            --medium-gray: #ccc;
            --dark-gray: #333;
            --success: #4CAF50;
            --warning: #ff9800;
            --danger: #f44336;
            --background: #ffffff;
            --text: #333333;
            --card-bg: #ffffff;
            --edit-color: #00796B;
            --whatsapp-color: #25D366;
            --whatsapp-dark: #128C7E;
        }
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            font-size: 15px;
            background-color: var(--light-gray);
            color: var(--text);
            margin: 5px;
            line-height: 1.55;
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: var(--card-bg);
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }
        h1 {
            font-size: 24px;
            text-align: center;
            letter-spacing: .2px;
        }
        h2 {
            font-size: 18px;
            margin-top: 20px;
            letter-spacing: .2px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 8px;
            border: 1px solid var(--medium-gray);
            text-align: left;
        }
        th {
            background-color: var(--light-gray);
        }
        input[type="text"], input[type="date"], input[type="time"], input[type="number"], select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            box-sizing: border-box;
            background-color: var(--card-bg);
            color: var(--text);
            font-size: 14px;
        }
        td input, td select { width: auto; }
        .signature { margin-top: 15px; }
        .footer {
            margin-top: 15px;
            font-size: 12px;
            text-align: center;
            color: #666;
        }
        
        /* Toolbar e botões */
        .toolbar {
            position: sticky;
            top: 0;
            z-index: 999;
            background: var(--light-gray);
            padding: 10px 0;
            max-width: 900px;
            margin: 0 auto 5px;
            text-align: right;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-end;
            border-radius: 5px;
        }
        .toolbar.hidden { display: none !important; }
        .toolbar button {
            color: #fff;
            border: none;
            padding: 10px 14px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.10);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .btn-print { background: var(--primary-color); }
        .btn-print:hover { background: var(--primary-dark); }
        .btn-email { background: var(--secondary-color); }
        .btn-email:hover { background: var(--secondary-dark); }
        .btn-whatsapp { background: var(--whatsapp-color); }
        .btn-whatsapp:hover { background: var(--whatsapp-dark); }
        .btn-save { background: var(--success); }
        .btn-save:hover { background: #3d8b40; }
        .btn-history { background: #795548; }
        .btn-history:hover { background: #6D4C41; }
        .btn-edit { background: var(--edit-color); }
        .btn-edit:hover { background: #00695C; }
        .btn-trends { background: #009688; }
        .btn-trends:hover { background: #00796B; }
        .btn-toggle-details { background: #607D8B; }
        .btn-toggle-details:hover { background: #455A64; }
        
        /* Botão flutuante para alternar a barra */
        .fab-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1002;
            background: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 28px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 20px;
        }
        .fab-toggle:hover { background: var(--primary-dark); }
        .fab-toggle:active { transform: translateY(1px); }
        
        /* Indicador de carregamento */
        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: var(--primary-color);
            z-index: 1005;
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }
        .loading-indicator.active {
            transform: scaleX(1);
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 14px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            max-width: 320px;
            font-size: 14px;
        }
        .notification.success { background: var(--success); color: white; }
        .notification.error { background: var(--danger); color: white; }
        .notification.warning { background: var(--warning); color: white; }
        .notification.info { background: var(--secondary-color); color: white; }
        .required-field {
            border: 2px solid var(--primary-color) !important;
            background-color: #fff2f2;
        }
        
        /* Status counters */
        .status-counters {
            display: flex;
            justify-content: space-around;
            margin: 10px;
            flex-wrap: wrap;
            gap: 5px;
        }
        .status-counter {
            padding: 5px 5px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            text-align: center;
            min-width: 120px;
        }
        .status-ok { background-color: var(--success); }
        .status-ruim { background-color: var(--warning); }
        .status-quebrado { background-color: #ff5722; }
        .status-faltando { background-color: #9c27b0; }
        .status-parar { background-color: var(--danger); }
        .status-counters .status-counter {
            padding: 5px 5px;
            min-width: 90px;
            font-size: 13px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .critical-item { background-color: #fff2f2 !important; font-weight: bold; }
        .item-highlight { animation: highlight 2s ease; background-color: #ffffd0; }
        @keyframes highlight { 0% { background-color: #ffffd0; } 100% { background-color: transparent; } }
        .save-indicator { font-size: 12px; color: #666; margin-left: 10px; font-style: italic; }
        
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow-y: auto; }
        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: var(--text); }
        
        /* Modal de boas-vindas */
        .welcome-modal .modal-content { max-width: 800px; }
        .welcome-header { text-align: center; margin-bottom: 20px; }
        .welcome-header h1 { font-size: 28px; color: var(--primary-color); border: none; }
        .welcome-section { margin-bottom: 20px; }
        .welcome-section h2 { font-size: 20px; margin-top: 15px; margin-bottom: 10px; }
        .welcome-section ul { padding-left: 20px; }
        .welcome-section li { margin-bottom: 8px; }
        .welcome-footer { text-align: center; margin-top: 25px; }
        .btn-welcome { background: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .btn-welcome:hover { background: var(--primary-dark); }
        
        /* Upload de fotos (gerais) */
        .photo-upload { margin: 10px 0; }
        .photo-preview { max-width: 200px; max-height: 200px; margin: 5px; border-radius: 5px; }
        
        /* Histórico */
        .history-item { padding: 10px; border: 1px solid var(--medium-gray); margin: 5px 0; border-radius: 5px; cursor: pointer; background-color: var(--light-gray); }
        .history-item:hover { background-color: var(--medium-gray); }
        
        /* Localização */
        .location-info { font-size: 12px; color: #666; margin-top: 5px; }
        .mobile-optimized select, .mobile-optimized input[type="text"] { font-size: 16px; }
        
        /* Novos estilos para melhorias */
        .search-box {
            margin: 10px 0;
            padding: 8px;
            width: 100%;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            font-size: 14px;
        }
        .batch-edit {
            margin: 10px 0;
            padding: 10px;
            background: var(--light-gray);
            border-radius: 5px;
            display: none;
            font-size: 14px;
        }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .dashboard-card { background: var(--card-bg); padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .dashboard-card h3 { margin: 0 0 10px 0; font-size: 15px; font-weight: 600; }
        .dashboard-card .value { font-size: 22px; font-weight: 700; color: var(--primary-color); }
        .lazy-load { opacity: 0; transition: opacity 0.3s; }
        .lazy-load.loaded { opacity: 1; }
        .keyboard-shortcuts { position: fixed; bottom: 10px; left: 10px; background: var(--card-bg); padding: 10px; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-size: 12px; display: none; }
        .keyboard-shortcuts.show { display: block; }
        
        /* Compactar a tabela de STATUS DE INSPEÇÃO */
        #inspection-table { font-size: 13px; }
        #inspection-table th, #inspection-table td { padding: 2px 4px; line-height: 1.3; }
        
        /* Colunas fixas (1, 2, 4) - tamanho mínimo absoluto */
        #inspection-table th:nth-child(1), 
        #inspection-table td:nth-child(1) { 
            width: 20px !important; 
            min-width: 20px !important;
            max-width: 20px !important;
            padding: 0 !important;
            overflow: hidden;
        }
        
        #inspection-table th:nth-child(2), 
        #inspection-table td:nth-child(2) { 
            width: 25px !important; 
            min-width: 25px !important;
            max-width: 25px !important;
            text-align: center !important;
            padding: 0 !important;
            overflow: hidden;
        }
        
        #inspection-table th:nth-child(4), 
        #inspection-table td:nth-child(4) { 
            width: 70px !important; 
            min-width: 70px !important;
            max-width: 70px !important;
            padding: 0 !important;
            overflow: hidden;
        }
        
        /* Ajustar o checkbox para caber no espaço reduzido */
        #inspection-table input[type="checkbox"] {
            width: 16px !important;
            height: 16px !important;
            margin: 2px !important;
        }
        
        /* Ajustar o select de status para caber no espaço reduzido */
        #inspection-table select.status-select {
            width: 66px !important;
            height: 20px !important;
            font-size: 11px !important;
            padding: 0 2px !important;
            margin: 0 !important;
        }
        
        /* Colunas responsivas: 3 e 5 */
        #inspection-table th:nth-child(3),
        #inspection-table td:nth-child(3) {
            width: auto !important;
            min-width: 180px !important;
            white-space: normal !important;
            overflow: visible !important;
            text-overflow: clip !important;
        }
        
        #inspection-table th:nth-child(5),
        #inspection-table td:nth-child(5) {
            width: auto !important;
            min-width: 130px !important;
        }
        
        #inspection-table input.obs-input { 
            padding: 1px 2px !important; 
            font-size: 13px !important; 
            box-sizing: border-box !important;
        }
        
        /* Compactar outras tabelas (Dados básicos e Dados da Viatura) */
        .compact-table { font-size: 13px; }
        .compact-table th, .compact-table td { padding: 1px 2px; line-height: 1.3; }
        .compact-table th { white-space: nowrap; }
        .compact-table input[type="text"],
        .compact-table input[type="date"],
        .compact-table input[type="time"],
        .compact-table input[type="number"],
        .compact-table select,
        .compact-table textarea {
            font-size: 13px;
            padding: 2px 3px;
            height: 28px;
        }
        .compact-table input[type="radio"] { margin-right: 2px; }
        .compact-table input[type="radio"] + label { margin-right: 5px; font-size: 13px; }
        
        /* Área de observações */
        #observacoesAvarias { font-size: 13px; }
        
        /* Indicador de status offline */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: var(--danger);
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            z-index: 1004;
            display: none;
        }
        .offline-indicator.show {
            display: block;
        }
        
        /* Relatório de tendência */
        .trend-chart {
            width: 100%;
            height: 300px;
            margin: 20px 0;
        }
        .trend-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--medium-gray);
        }
        .trend-item:last-child {
            border-bottom: none;
        }
        .trend-bar {
            height: 20px;
            background-color: var(--warning);
            border-radius: 4px;
            margin-top: 5px;
        }
        
        /* ===== MELHORIAS DE LAYOUT ===== */
        .container {
            padding: 15px;
        }
        
        #inspection-table {
            table-layout: fixed;
        }
        
        #inspection-table input.obs-input {
            width: 100%;
            box-sizing: border-box;
        }
        
        /* Melhorias para dispositivos móveis */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                margin: 0;
                border-radius: 0;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h2 {
                font-size: 16px;
            }
            
            .toolbar { 
                flex-direction: column; 
                align-items: stretch;
                position: relative;
                top: 0;
            }
            
            .toolbar button { 
                width: 100%; 
                justify-content: center;
                margin-bottom: 5px;
            }
            
            .status-counters { 
                flex-direction: column; 
            }
            
            .status-counter {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .modal-content { 
                width: 90%; 
                margin: 2% auto; 
                padding: 12px;
            }
            
            .welcome-modal .modal-content { 
                width: 95%; 
                padding: 10px;
            }
            
            .welcome-header h1 { 
                font-size: 18px;
                margin-bottom: 10px;
            }
            
            .welcome-header p {
                font-size: 12px;
                margin-bottom: 15px;
            }
            
            .welcome-section h2 { 
                font-size: 14px;
                margin-top: 10px;
                margin-bottom: 5px;
            }
            
            .welcome-section ul {
                padding-left: 15px;
                margin-bottom: 10px;
            }
            
            .welcome-section li {
                font-size: 12px;
                margin-bottom: 5px;
            }
            
            .welcome-footer {
                margin-top: 15px;
            }
            
            .btn-welcome {
                padding: 10px 20px;
                font-size: 14px;
            }
            
            .dashboard { 
                grid-template-columns: 1fr; 
            }
            
            /* Ajustes específicos para a tabela de inspeção em mobile */
            #inspection-table {
                font-size: 12px;
            }
            
            /* Colunas fixas em mobile - tamanho mínimo absoluto */
            #inspection-table th:nth-child(1), 
            #inspection-table td:nth-child(1) { 
                width: 18px !important; 
                min-width: 18px !important;
                max-width: 18px !important;
                padding: 0 !important;
            }
            
            #inspection-table th:nth-child(2), 
            #inspection-table td:nth-child(2) { 
                width: 22px !important; 
                min-width: 22px !important;
                max-width: 22px !important;
                text-align: center !important;
                padding: 0 !important;
            }
            
            #inspection-table th:nth-child(4), 
            #inspection-table td:nth-child(4) { 
                width: 60px !important; 
                min-width: 60px !important;
                max-width: 60px !important;
                padding: 0 !important;
            }
            
            /* Ajustar o checkbox para caber no espaço reduzido em mobile */
            #inspection-table input[type="checkbox"] {
                width: 14px !important;
                height: 14px !important;
                margin: 1px !important;
            }
            
            /* Ajustar o select de status para caber no espaço reduzido em mobile */
            #inspection-table select.status-select {
                width: 56px !important;
                height: 18px !important;
                font-size: 10px !important;
                padding: 0 1px !important;
                margin: 0 !important;
            }
            
            #inspection-table th:nth-child(3),
            #inspection-table td:nth-child(3) {
                width: auto !important;
                min-width: 100px !important;
                white-space: normal !important;
                overflow: visible !important;
            }
            
            #inspection-table th:nth-child(5),
            #inspection-table td:nth-child(5) {
                width: auto !important;
                min-width: 150px !important;
            }
            
            .compact-table input[type="text"],
            .compact-table input[type="date"],
            .compact-table input[type="time"],
            .compact-table input[type="number"],
            .compact-table select {
                font-size: 16px;
                padding: 8px;
            }
        }
        
        /* Melhorias de impressão */
        @media print {
            .no-print, .no-print * { display: none !important; }
            .fab-toggle { display: none !important; }
            body, .container { 
                margin: 0; 
                padding: 0; 
                box-shadow: none; 
                border-radius: 0; 
                font-size: 12px;
            }
            .status-counters { display: none; }
            .dashboard { display: none; }
            
            #inspection-table {
                font-size: 10px;
            }
            
            #inspection-table th, 
            #inspection-table td {
                padding: 1px !important;
            }
            
            #inspection-table th:nth-child(3),
            #inspection-table td:nth-child(3) {
                white-space: normal;
                overflow: visible;
            }
        }
        
        /* Melhorias de acessibilidade */
        input:focus, select:focus, textarea:focus {
            outline: 2px solid var(--secondary-color);
            outline-offset: 2px;
        }
        
        button:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        
        /* Melhorias visuais para os botões */
        .toolbar button {
            transition: all 0.2s ease;
        }
        
        /* Destaque para itens críticos */
        .critical-item {
            background-color: #fff2f2 !important;
            border-left: 3px solid var(--primary-color);
        }
        
        /* Melhorias no formulário de dados básicos */
        .compact-table td:first-child {
            width: 35%;
        }
        
        /* Melhorias para a área de observações */
        #observacoesAvarias {
            min-height: 120px;
            line-height: 1.4;
        }
        
        /* Estilo para o botão de Google Maps */
        .btn-maps {
            background-color: #4285F4;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-maps:hover {
            background-color: #3367D6;
        }
        
        /* Estilo para seções ocultáveis */
        .details-section {
            transition: all 0.3s ease;
        }
        
        .details-hidden {
            display: none !important;
        }
        
        /* Garantir que o dashboard e contadores também sejam ocultados */
        .dashboard.details-hidden,
        .status-counters.details-hidden {
            display: none !important;
        }
        
        /* Confirmação de saída */
        .exit-confirmation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1006;
        }
        
        .exit-confirmation-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 400px;
            text-align: center;
        }
        
        .exit-confirmation-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-confirm-exit {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-cancel-exit {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* Estilo para botão de cópia */
        .btn-copy {
            background-color: #607D8B;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 8px;
            margin-left: 10px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-copy:hover {
            background-color: #455A64;
        }
    </style>
</head>
<body>
    <!-- Indicador de carregamento -->
    <div id="loadingIndicator" class="loading-indicator"></div>
    
    <!-- Indicador de status offline -->
    <div id="offlineIndicator" class="offline-indicator">
        Você está offline. As alterações serão sincronizadas quando a conexão for restabelecida.
    </div>
    
    <!-- Confirmação de saída -->
    <div id="exitConfirmation" class="exit-confirmation">
        <div class="exit-confirmation-content">
            <h3>Alterações não salvas</h3>
            <p>Você tem alterações que não foram salvas. Deseja salvar antes de sair?</p>
            <div class="exit-confirmation-buttons">
                <button class="btn-confirm-exit" onclick="confirmExit(true)">Salvar e Sair</button>
                <button class="btn-cancel-exit" onclick="confirmExit(false)">Sair sem Salvar</button>
                <button class="btn-cancel-exit" onclick="cancelExit()">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Boas-vindas -->
    <div id="welcomeModal" class="modal welcome-modal">
        <div class="modal-content">
            <div class="welcome-header">
                <h1>🏥 Check-list Diário - LEFE</h1>
                <p>Sistema web para check-list diário de inspeção veicular e equipamentos do Serviço de Emergências Médicas (LEFE).</p>
            </div>
            
            <div class="welcome-section">
                <h2>Funcionalidades Principais</h2>
                <h3>📝 Registro de Dados</h3>
                <ul>
                    <li>Informações básicas (hospital, data, horários, condutores)</li>
                    <li>Dados da viatura (placa, quilometragem, combustível, etc.)</li>
                    <li>Validação automática de placa brasileira</li>
                </ul>
                
                <h3>✅ Check-list de Inspeção</h3>
                <ul>
                    <li>Lista completa de itens para inspeção</li>
                    <li>Status para cada item: OK, Ruim, Quebrado, Faltando, Parar VTR</li>
                    <li>Itens críticos destacados visualmente</li>
                    <li>Campos para observações por item</li>
                </ul>
                
                <h3>🛠️ Recursos Avançados</h3>
                <ul>
                    <li>Upload de fotos (opcional)</li>
                    <li>Armazenamento local</li>
                    <li>Histórico de check-lists anteriores</li>
                    <li>Relatórios de tendência</li>
                    <li>Modo offline robusto</li>
                </ul>
            </div>
            
            <div class="welcome-section">
                <h2>🙋 Como Utilizar</h2>
                <ol>
                    <li>Preencha os campos básicos</li>
                    <li>Informe os dados da viatura</li>
                    <li>Selecione o status para cada item</li>
                    <li>Adicione observações se necessário</li>
                    <li>Salve, exporte ou envie por e-mail</li>
                </ol>
            </div>
            
            <div class="welcome-footer">
                <button class="btn-welcome" onclick="fecharBoasVindas()">Começar a usar</button>
            </div>
        </div>
    </div>
    
    <!-- Barra de ferramentas melhorada (oculta por padrão) -->
    <div class="toolbar no-print hidden">
        <button class="btn-print" onclick="window.print()"><span>🖨️</span> Imprimir</button>
        <button class="btn-email" onclick="enviarPorEmail()"><span>✉️</span> E-mail</button>
        <button class="btn-whatsapp" onclick="enviarPorWhatsApp()"><span>📱</span> WhatsApp</button>
        <button class="btn-save" onclick="salvarDados()"><span>💾</span> Salvar</button>
        <button class="btn-history" onclick="abrirHistorico()"><span>📋</span> Histórico</button>
        <button class="btn-trends" onclick="abrirRelatorioTendencia()"><span>📈</span> Tendências</button>
        <button id="btnBatchEdit" class="btn-edit" onclick="toggleBatchEdit()"><span>📝</span> Edição em Lote</button>
        <button id="btnToggleDetails" class="btn-toggle-details" onclick="toggleDetailsSections()"><span>👁️</span> <span id="btnToggleDetailsText">Ocultar Detalhes</span></button>
        <span id="saveIndicator" class="save-indicator"></span>
    </div>
    
    <!-- Botão flutuante para alternar a barra -->
    <button id="toggleToolbarFab"
            class="fab-toggle no-print"
            onclick="toggleToolbar()"
            title="Mostrar/Ocultar barra (Ctrl+B)"
            aria-label="Mostrar/Ocultar barra">☰</button>
    
    <div class="container">
        <h1>🚑 LEFE - SERVIÇO DE EMERGÊNCIAS MÉDICAS</h1>
        <h2>📋 CHECK-LIST DIÁRIO DE INSPEÇÃO VEICULAR E EQUIPAMENTOS</h2>
        
        <!-- Dashboard de estatísticas -->
        <div class="dashboard no-print">
            <div class="dashboard-card">
                <h3>✅ Itens OK</h3>
                <div class="value" id="dashboard-ok">0</div>
            </div>
            <div class="dashboard-card">
                <h3>⚠️ Problemas</h3>
                <div class="value" id="dashboard-problems">0</div>
            </div>
            <div class="dashboard-card">
                <h3>🚨 Críticos</h3>
                <div class="value" id="dashboard-critical">0</div>
            </div>
            <div class="dashboard-card">
                <h3>📊 Completos</h3>
                <div class="value" id="dashboard-completion">0%</div>
            </div>
        </div>
        
        <div class="status-counters no-print">
            <div class="status-counter status-ok">✅ OK: <span id="count-ok">0</span></div>
            <div class="status-counter status-ruim">⚠️ (R) Ruim: <span id="count-ruim">0</span></div>
            <div class="status-counter status-quebrado">🛠️ (Q) Quebrado: <span id="count-quebrado">0</span></div>
            <div class="status-counter status-faltando">❌ (F) Faltando: <span id="count-faltando">0</span></div>
            <div class="status-counter status-parar">🚨 (P) Parar VTR: <span id="count-parar">0</span></div>
        </div>
        
        <!-- Modo de edição em lote -->
        <div id="batchEdit" class="batch-edit no-print">
            <h3>📝 Edição em Lote</h3>
            <p>Selecione o status que deseja aplicar a vários itens:</p>
            <select id="batchStatus">
                <option value=""></option>
                <option value="✅ OK">✅ OK</option>
                <option value="⚠️ Ruim">⚠️ Ruim</option>
                <option value="🛠️ Quebrado">🛠️ Quebrado</option>
                <option value="❌ Faltando">❌ Faltando</option>
                <option value="🚨 Parar VTR" title="Item crítico: veículo não deve operar">🚨 (P)</option>
            </select>
            <button onclick="aplicarEdicaoEmLote()">Aplicar aos itens selecionados</button>
            <button onclick="selecionarTodosItens()">Selecionar todos</button>
            <button onclick="desselecionarTodosItens()">Desselecionar todos</button>
        </div>
        
        <!-- Busca -->
        <input type="text" id="searchInput" class="search-box no-print" placeholder="🔍 Buscar item..." oninput="filtrarItens()">
        
        <!-- Tabela Dados Básicos -->
        <table class="compact-table details-section">
            <tr><td><strong>🏥 Hospital:</strong></td><td><input type="text" id="hospital" placeholder="Hospital Raimundo Lima"></td></tr>
            <tr><td><strong>📆 Data:</strong></td><td><input type="date" id="data"></td></tr>
            <tr><td><strong>⏰ Horário de Entrada:</strong></td><td><input type="time" id="horarioEntrada" value="07:00"></td></tr>
            <tr><td><strong>⏰ Horário de Saída:</strong></td><td><input type="time" id="horarioSaida" value="19:00"></td></tr>
            <tr><td><strong>🙋 Condutor de Plantão:</strong></td><td><input type="text" id="condutorPlantao" placeholder="Nome completo"></td></tr>
            <tr><td><strong>🫂 Recebendo de:</strong></td><td><input type="text" id="recebendoDe" placeholder="Nome do condutor anterior"></td></tr>
        </table>
        
        <h2 class="details-section">🚑 DADOS DA VIATURA (BASICA / USA)</h2>
        <table class="compact-table details-section">
            <tr><th>Item</th><th>Informação</th></tr>
            <tr>
                <td><strong>Ambulância</strong></td>
                <td>
                    <input type="radio" id="ambulanciaBasica" name="ambulanciaStatus" value="BÁSICA"> 
                    <label for="ambulanciaBasica">BÁSICA</label>
                    <input type="radio" id="ambulanciaUSA" name="ambulanciaStatus" value="USA"> 
                    <label for="ambulanciaUSA">USA / UTI</label>
                </td>
            </tr>
            <tr><td><strong>Placa</strong></td><td><input type="text" id="placa" placeholder="Ex: ABC1234 ou ABC1D23" onblur="validarPlaca()"></td></tr>
            <tr><td><strong>Km Atual</strong></td><td><input type="number" id="kmAtual" placeholder="Ex: 337847"></td></tr>
            <tr><td><strong>Nível de Combustível</strong></td><td><input type="text" id="nivelCombustivel" placeholder="Ex: 5/10 traços ou 1/2 tanque"></td></tr>
            <tr><td><strong>CRV Válido até</strong></td><td><input type="number" id="crvValido" placeholder="Ano (ex: 2024)"></td></tr>
            <tr><td><strong>Próxima Troca de Óleo km</strong></td><td><input type="number" id="proximaTrocaOleo" placeholder="Km da próxima troca"></td></tr>
            <tr>
                <td><strong>Cartão de Abastecimento</strong></td>
                <td>
                    <input type="radio" id="cartaoDisponivel" name="cartaoStatus" value="Disponível"> 
                    <label for="cartaoDisponivel">Disponível</label>
                    <input type="radio" id="cartaoNaoDisponivel" name="cartaoStatus" value="Não Disponível"> 
                    <label for="cartaoNaoDisponivel">Não Disponível</label>
                </td>
            </tr>
        </table>
        
        <!-- Localização -->
        <div id="localizacao" class="location-info no-print details-section"></div>
        
        <h2>📋 STATUS DE INSPEÇÃO</h2>
        <p><em>Selecione o status: ✅ OK | ⚠️ (R) Ruim | 🛠️(Q) Quebrado | ❌ (F) Faltando | 🚨 (P) Parar VTR</em></p>
        <table id="inspection-table">
            <thead>
                <tr>
                    <th class="no-print"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th>
                    <th>#</th><th>Item</th><th>Status</th><th>Observação</th>
                </tr>
            </thead>
            <tbody>
                <!-- Itens gerados via JS -->
            </tbody>
        </table>
        
        <h2>🛠️ OBSERVAÇÕES GERAIS / AVARIAS</h2>
        <textarea id="observacoesAvarias" rows="8" style="width: 100%;" placeholder="Digite suas observações aqui. Use Enter para quebrar linhas."></textarea>
        
        <!-- Upload de fotos gerais -->
        <div class="photo-upload no-print">
            <label for="fotosGerais"><strong>📷 Fotos Gerais (opcional):</strong></label>
            <input type="file" id="fotosGerais" accept="image/*" multiple capture="camera">
            <div id="previewFotosGerais"></div>
        </div>
        
        <h2>✍️ ASSINATURAS</h2>
        <div class="signature">
            <p><strong>Condutor Recebendo o Plantão:</strong> _________________________________________</p>
            <p><strong>Condutor Entregando o Plantão:</strong> _________________________________________</p>
        </div>
        <div class="footer">
            <p>📝 Documento válido como registro de inspeção diária – LEFE<br>
            🗂️ Arquivar após preenchimento.<br>⏳ Atualizado em 2025.</p>
        </div>
    </div>
    
    <!-- Modal do Histórico -->
    <div id="modalHistorico" class="modal no-print">
        <div class="modal-content">
            <span class="close" onclick="fecharHistorico()">&times;</span>
            <h2>📋 Histórico de Check-lists</h2>
            <div id="listaHistorico"></div>
        </div>
    </div>
    
    <!-- Modal de Relatório de Tendência -->
    <div id="modalTendencia" class="modal no-print">
        <div class="modal-content">
            <span class="close" onclick="fecharRelatorioTendencia()">&times;</span>
            <h2>📈 Relatório de Tendência de Problemas</h2>
            <p>Este relatório mostra os itens que mais apresentaram problemas nos últimos check-lists.</p>
            <div id="conteudoRelatorioTendencia">
                <p>Carregando dados...</p>
            </div>
        </div>
    </div>
    
    <!-- Modal de Backup -->
    <div id="modalBackup" class="modal no-print">
        <div class="modal-content">
            <span class="close" onclick="fecharBackup()">&times;</span>
            <h2>☁️ Backup de Dados</h2>
            <p>Faça backup dos seus check-lists para não perder seus dados.</p>
            <button onclick="fazerBackup()">📦 Fazer Backup</button>
            <button onclick="restaurarBackup()">🔄 Restaurar Backup</button>
            <div id="statusBackup"></div>
        </div>
    </div>
    
    <!-- Modal de Alternativa WhatsApp -->
    <div id="modalWhatsApp" class="modal no-print">
        <div class="modal-content">
            <span class="close" onclick="fecharModalWhatsApp()">&times;</span>
            <h2>📱 Alternativa para WhatsApp</h2>
            <p>Não foi possível abrir o WhatsApp diretamente. Use uma das opções abaixo:</p>
            <div style="margin: 20px 0;">
                <button onclick="abrirWhatsAppWeb()" class="btn-whatsapp" style="width: 100%; margin-bottom: 10px;">
                    <span>🌐</span> Abrir WhatsApp Web
                </button>
                <button onclick="copiarMensagemWhatsApp()" class="btn-copy" style="width: 100%; margin-bottom: 10px;">
                    <span>📋</span> Copiar Mensagem
                </button>
            </div>
            <div id="mensagemWhatsAppPreview" style="background: #f5f5f5; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto; font-size: 12px; white-space: pre-wrap;"></div>
        </div>
    </div>
    
    <!-- Notificação -->
    <div id="notification" class="notification"></div>
    
    <!-- Atalhos de teclado -->
    <div id="keyboardShortcuts" class="keyboard-shortcuts">
        <strong>Atalhos de teclado:</strong><br>
        Ctrl+S - Salvar<br>
        Ctrl+E - Enviar por e-mail<br>
        Ctrl+W - Enviar por WhatsApp<br>
        Ctrl+P - Imprimir<br>
        Ctrl+F - Buscar<br>
        Ctrl+B - Mostrar/Ocultar barra<br>
        Ctrl+D - Mostrar/Ocultar detalhes<br>
        Esc - Fechar modais
    </div>
    
    <script>
        // Lista de itens sem a propriedade critical fixa
        const inspectionItems = [
            { name: "Óleo do motor" },
            { name: "Óleo hidráulico (caixa de direção)" },
            { name: "Fluido do radiador" },
            { name: "Fluido de freio" },
            { name: "Água do limpador de para-brisa" },
            { name: "Correia do alternador" },
            { name: "Correia dentada do motor" },
            { name: "Retrovisores" },
            { name: "Para-brisa" },
            { name: "Caixa de marchas" },
            { name: "Pisca dos retrovisores" },
            { name: "Faróis dianteiros" },
            { name: "Lanternas traseiras" },
            { name: "Buzina e pisca de alerta" },
            { name: "Botões dos vidros elétricos" },
            { name: "Travamento das portas" },
            { name: "Sinalizadores de emergência" },
            { name: "Sirene" },
            { name: "Luzes internas" },
            { name: "Farol de embarque" },
            { name: "Freio de estacionamento" },
            { name: "Pastilhas de freio (dianteira/traseira)" },
            { name: "Pneus" },
            { name: "Macaco, chave de roda, triângulo" },
            { name: "Limpadores/palhetas do para-brisa" },
            { name: "Limpeza interna" },
            { name: "Limpeza externa" },
            { name: "Ar condicionado (dianteiro)" },
            { name: "Ar condicionado (traseiro)" },
            { name: "Extintor de incêndio" },
            { name: "Alarme de estacionamento" },
            { name: "Alinhamento/Balanceamento" },
            { name: "Cilindro de oxigênio fixo (01)" },
            { name: "Cintos de segurança" },
            { name: "Maca e cinto de segurança" },
            { name: "Cadeira de rodas (se aplicável)" },
            { name: "Prancha/Escada" },
            { name: "Bateria, inversor, transformador" },
            { name: "Bancos e capas" },
            { name: "Pintura/Plotagem" },
            { name: "Câmera de ré (se aplicável)" },
            { name: "Chave de troca de oxigênio" },
            { name: "Bala de oxigênio portátil" },
            { name: "Desfibrilador" },
            { name: "Monitor" },
            { name: "Respirador" },
            { name: "Oxímetro" },
            { name: "Termômetro" },
            { name: "Glicosímetro" },
            { name: "Bolsa de medicação" },
            { name: "Bolsa de entubação" },
            { name: "Bolsa de ventilação" },
            { name: "Bolsa via aérea" },
            { name: "Armário do salão" },
            { name: "Gavetas do salão" },
            { name: "Baú do salão" },
            { name: "Painel de controle do salão" }
        ];
        // Itens críticos por tipo de ambulância
        const criticalItemsByType = {
            "BÁSICA": [
                "Óleo do motor",
                "Óleo hidráulico (caixa de direção)",
                "Fluido do radiador",
                "Fluido de freio",
                "Correia do alternador",
                "Correia dentada do motor",
                "Retrovisores",
                "Para-brisa",
                "Caixa de marchas",
                "Faróis dianteiros",
                "Lanternas traseiras",
                "Travamento das portas",
                "Sinalizadores de emergência",
                "Sirene",
                "Luzes internas",
                "Freio de estacionamento",
                "Pastilhas de freio (dianteira/traseira)",
                "Pneus",
                "Macaco, chave de roda, triângulo",
                "Extintor de incêndio",
                "Cilindro de oxigênio fixo (01)",
                "Cintos de segurança",
                "Maca e cinto de segurança",
                "Bateria, inversor, transformador",
                "Chave de troca de oxigênio",
                "Bala de oxigênio portátil",
                "Oxímetro",
                "Termômetro",
                "Glicosímetro",
                "Painel de controle do salão"
            ],
            "USA": [
                "Óleo do motor",
                "Óleo hidráulico (caixa de direção)",
                "Fluido do radiador",
                "Fluido de freio",
                "Correia do alternador",
                "Correia dentada do motor",
                "Retrovisores",
                "Para-brisa",
                "Caixa de marchas",
                "Faróis dianteiros",
                "Lanternas traseiras",
                "Travamento das portas",
                "Sinalizadores de emergência",
                "Sirene",
                "Luzes internas",
                "Freio de estacionamento",
                "Pastilhas de freio (dianteira/traseira)",
                "Pneus",
                "Macaco, chave de roda, triângulo",
                "Extintor de incêndio",
                "Cilindro de oxigênio fixo (01)",
                "Cintos de segurança",
                "Maca e cinto de segurança",
                "Bateria, inversor, transformador",
                "Chave de troca de oxigênio",
                "Bala de oxigênio portátil",
                "Desfibrilador",
                "Monitor",
                "Respirador",
                "Oxímetro",
                "Termômetro",
                "Glicosímetro",
                "Bolsa de medicação",
                "Bolsa de entubação",
                "Bolsa de ventilação",
                "Bolsa via aérea",
                "Painel de controle do salão",
                "Ar condicionado (dianteiro)",
                "Ar condicionado (traseiro)",
                "Prancha/Escada"
            ]
        };
        
        const TOOLBAR_HIDDEN_KEY = 'lefeToolbarHidden';
        const DETAILS_HIDDEN_KEY = 'lefeDetailsHidden';
        let autoSaveInterval;
        let lastSaveTime = null;
        let coordenadasGPS = null;
        let filteredItems = [];
        let isOnline = navigator.onLine;
        let syncQueue = [];
        let pendingSync = false;
        let dadosModificados = false;
        let db;
        let pendingExitAction = null;
        let mensagemWhatsAppAtual = '';
        
        // Inicializar IndexedDB
        function initIndexedDB() {
            const request = indexedDB.open('LEFE_Checklist_DB', 1);
            
            request.onerror = function(event) {
                console.error('Erro ao abrir IndexedDB:', event.target.error);
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                console.log('IndexedDB inicializado com sucesso');
            };
            
            request.onupgradeneeded = function(event) {
                db = event.target.result;
                
                // Criar object store para checklists
                if (!db.objectStoreNames.contains('checklists')) {
                    const objectStore = db.createObjectStore('checklists', { keyPath: 'id' });
                    objectStore.createIndex('placa', 'placa', { unique: false });
                    objectStore.createIndex('data', 'data', { unique: false });
                    objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
                
                // Criar object store para sincronização
                if (!db.objectStoreNames.contains('syncQueue')) {
                    const syncStore = db.createObjectStore('syncQueue', { keyPath: 'id', autoIncrement: true });
                    syncStore.createIndex('action', 'action', { unique: false });
                }
            };
        }
        
        // Salvar dados no IndexedDB
        function salvarDadosIndexedDB(dados, key) {
            if (!db) return false;
            
            const transaction = db.transaction(['checklists'], 'readwrite');
            const objectStore = transaction.objectStore('checklists');
            
            const checklist = {
                id: key,
                dados: dados,
                timestamp: new Date().toISOString()
            };
            
            const request = objectStore.put(checklist);
            
            request.onsuccess = function(event) {
                console.log('Dados salvos no IndexedDB:', key);
            };
            
            request.onerror = function(event) {
                console.error('Erro ao salvar no IndexedDB:', event.target.error);
            };
            
            return true;
        }
        
        // Carregar dados do IndexedDB
        function carregarDadosIndexedDB(key) {
            if (!db) return null;
            
            const transaction = db.transaction(['checklists'], 'readonly');
            const objectStore = transaction.objectStore('checklists');
            
            const request = objectStore.get(key);
            
            return new Promise((resolve, reject) => {
                request.onsuccess = function(event) {
                    resolve(event.target.result ? event.target.result.dados : null);
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao carregar do IndexedDB:', event.target.error);
                    reject(null);
                };
            });
        }
        
        // Obter histórico do IndexedDB
        function getHistoricoIndexedDB() {
            if (!db) return [];
            
            const transaction = db.transaction(['checklists'], 'readonly');
            const objectStore = transaction.objectStore('checklists');
            const index = objectStore.index('timestamp');
            
            return new Promise((resolve, reject) => {
                const request = index.openCursor(null, 'prev');
                const historico = [];
                
                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        historico.push({
                            key: cursor.value.id,
                            dados: cursor.value.dados
                        });
                        cursor.continue();
                    } else {
                        resolve(historico);
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao obter histórico:', event.target.error);
                    reject([]);
                };
            });
        }
        
        // Toolbar toggle (mostrar/ocultar)
        function updateToolbarFab(hidden) {
            const fab = document.getElementById('toggleToolbarFab');
            if (!fab) return;
            fab.textContent = hidden ? '☰' : '👆';
            const label = hidden ? 'Mostrar barra (Ctrl+B)' : 'Ocultar barra (Ctrl+B)';
            fab.title = label;
            fab.setAttribute('aria-label', label);
        }
        
        function toggleToolbar(forceHidden) {
            const toolbar = document.querySelector('.toolbar');
            if (!toolbar) return;
            const shouldHide = typeof forceHidden === 'boolean'
                ? forceHidden
                : !toolbar.classList.contains('hidden');
            toolbar.classList.toggle('hidden', shouldHide);
            localStorage.setItem(TOOLBAR_HIDDEN_KEY, shouldHide ? '1' : '0');
            updateToolbarFab(shouldHide);
        }
        
        // Verificar se é a primeira visita e mostrar boas-vindas
        function verificarPrimeiraVisita() {
            const primeiraVisita = localStorage.getItem('lefePrimeiraVisita');
            if (!primeiraVisita) {
                document.getElementById('welcomeModal').style.display = 'block';
                localStorage.setItem('lefePrimeiraVisita', 'false');
            }
        }
        
        function fecharBoasVindas() {
            document.getElementById('welcomeModal').style.display = 'none';
        }
        
        // Validação de placa brasileira
        function validarPlaca() {
            const placaInput = document.getElementById("placa");
            const placa = placaInput.value.trim().toUpperCase();
            const regexAntigo = /^[A-Z]{3}-?\d{4}$/;
            const regexNovo = /^[A-Z]{3}\d[A-Z]\d{2}$/;
            if (placa && !regexAntigo.test(placa) && !regexNovo.test(placa)) {
                placaInput.classList.add('required-field');
                showNotification("Formato de placa inválido. Use ABC1234 ou ABC1D23", "error");
                return false;
            } else {
                placaInput.classList.remove('required-field');
                if (regexAntigo.test(placa.replace('-', ''))) {
                    placaInput.value = placa.replace('-', '');
                }
                return true;
            }
        }
        
        // Gera chave única: placa + data
        function getStorageKey() {
            const placa = document.getElementById("placa").value.trim().toUpperCase();
            const data = document.getElementById("data").value;
            return placa && data ? `checklist_${placa}_${data}` : null;
        }
        
        // Obter localização GPS
        function obterLocalizacao() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        coordenadasGPS = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            timestamp: new Date().toISOString()
                        };
                        
                        const localizacaoElement = document.getElementById('localizacao');
                        localizacaoElement.innerHTML = 
                            `📍 Localização: ${coordenadasGPS.latitude.toFixed(6)}, ${coordenadasGPS.longitude.toFixed(6)} (${new Date(coordenadasGPS.timestamp).toLocaleTimeString()}) 
                             <button onclick="mostrarLocalizacaoNoMapa()" class="btn-maps">Ver no Maps</button>`;
                    },
                    function(error) {
                        console.log("Erro ao obter localização:", error);
                        document.getElementById('localizacao').innerHTML = '📍 Localização não disponível';
                    }
                );
            }
        }
        
        // Função para abrir o Google Maps com as coordenadas atuais
        function mostrarLocalizacaoNoMapa() {
            if (coordenadasGPS && coordenadasGPS.latitude && coordenadasGPS.longitude) {
                const lat = coordenadasGPS.latitude.toFixed(6);
                const lon = coordenadasGPS.longitude.toFixed(6);
                const googleMapsUrl = `https://maps.google.com/?q=${lat},${lon}`;
                window.open(googleMapsUrl, '_blank');
            } else {
                showNotification("Localização não disponível. Verifique se o GPS está ativado.", "warning");
            }
        }
        
        // Lazy loading para itens da tabela
        function generateInspectionTable() {
            const tableBody = document.querySelector("#inspection-table tbody");
            const statusOptions = `
                <option value=""></option>
                <option value="✅ OK">✅ OK</option>
                <option value="⚠️ Ruim">⚠️ (R)</option>
                <option value="🛠️ Quebrado">🛠 (Q)</option>
                <option value="❌ Faltando">❌ (F)</option>
                <option value="🚨 Parar VTR">🚨 (P)</option>
            `;
            
            // Limpar tabela existente
            tableBody.innerHTML = '';
            
            // Criar um documento fragmento para melhor performance
            const fragment = document.createDocumentFragment();
            
            // Adicionar itens em lotes para melhor performance
            const batchSize = 10;
            let currentBatch = 0;
            
            function addBatch() {
                const end = Math.min(currentBatch + batchSize, inspectionItems.length);
                
                for (let i = currentBatch; i < end; i++) {
                    const item = inspectionItems[i];
                    const row = document.createElement('tr');
                    // Removido: if (item.critical) row.classList.add('critical-item');
                    row.innerHTML = `
                        <td class="no-print"><input type="checkbox" class="item-selector" data-id="${i + 1}"></td>
                        <td>${(i + 1).toString().padStart(2, '0')}</td>
                        <td>${item.name}</td>
                        <td><select id="status-${i + 1}" class="status-select">${statusOptions}</select></td>
                        <td><input type="text" id="obs-${i + 1}" class="obs-input" style="width: 100%;"></td>
                    `;
                    fragment.appendChild(row);
                }
                
                tableBody.appendChild(fragment);
                
                // Adicionar event listeners apenas para os itens adicionados
                for (let i = currentBatch; i < end; i++) {
                    const statusSelect = document.getElementById(`status-${i + 1}`);
                    const obsInput = document.getElementById(`obs-${i + 1}`);
                    
                    if (statusSelect) {
                        statusSelect.addEventListener('change', function() {
                            updateStatusCounters();
                            updateDashboard();
                            marcarModificado();
                        });
                    }
                    
                    if (obsInput) {
                        obsInput.addEventListener('input', debounce(() => {
                            marcarModificado();
                        }, 1000));
                    }
                }
                
                currentBatch = end;
                
                // Se ainda houver itens, continuar adicionando
                if (currentBatch < inspectionItems.length) {
                    setTimeout(addBatch, 10); // Pequeno delay para não bloquear a UI
                } else {
                    // Todos os itens foram adicionados
                    filteredItems = [...inspectionItems];
                    updateStatusCounters();
                    updateDashboard();
                    
                    // Verificar se a coluna de observação deve ser ocultada
                    const detailsPref = localStorage.getItem(DETAILS_HIDDEN_KEY);
                    if (detailsPref === 'true') {
                        toggleObservationColumn(true);
                    }
                    
                    // Verificar se há um tipo de ambulância selecionado e atualizar os itens críticos
                    const selectedAmbulance = document.querySelector('input[name="ambulanciaStatus"]:checked');
                    if (selectedAmbulance) {
                        updateCriticalItems(selectedAmbulance.value);
                    }
                }
            }
            
            // Iniciar o processo
            addBatch();
        }
        
        // Função para atualizar itens críticos baseado no tipo de ambulância
        function updateCriticalItems(type) {
            // Obter a lista de itens críticos para o tipo selecionado
            const criticalItems = criticalItemsByType[type] || [];
            
            // Percorrer todas as linhas da tabela de inspeção
            const rows = document.querySelectorAll('#inspection-table tbody tr');
            rows.forEach((row, index) => {
                const itemName = inspectionItems[index].name;
                if (criticalItems.includes(itemName)) {
                    row.classList.add('critical-item');
                } else {
                    row.classList.remove('critical-item');
                }
            });
            
            // Atualizar o dashboard para refletir os itens críticos
            updateDashboard();
        }
        
        function updateStatusCounters() {
            const counters = { '✅ OK': 0, '⚠️ Ruim': 0, '🛠️ Quebrado': 0, '❌ Faltando': 0, '🚨 Parar VTR': 0 };
            document.querySelectorAll('.status-select').forEach(select => {
                if (select.value && counters[select.value] !== undefined) counters[select.value]++;
            });
            
            document.getElementById('count-ok').textContent = counters['✅ OK'];
            document.getElementById('count-ruim').textContent = counters['⚠️ Ruim'];
            document.getElementById('count-quebrado').textContent = counters['🛠️ Quebrado'];
            document.getElementById('count-faltando').textContent = counters['❌ Faltando'];
            document.getElementById('count-parar').textContent = counters['🚨 Parar VTR'];
        }
        
        function updateDashboard() {
            const totalItems = inspectionItems.length;
            let completedItems = 0;
            let problemItems = 0;
            let criticalItems = 0;
            let okItems = 0;
            
            // Obter o tipo de ambulância selecionado
            const selectedAmbulance = document.querySelector('input[name="ambulanciaStatus"]:checked');
            const ambulanceType = selectedAmbulance ? selectedAmbulance.value : null;
            const criticalItemsList = ambulanceType ? criticalItemsByType[ambulanceType] : [];
            
            document.querySelectorAll('.status-select').forEach((select, index) => {
                const val = select.value;
                if (val) completedItems++;
                if (val === "✅ OK") okItems++;
                if (val && val !== "✅ OK") problemItems++;
                if (criticalItemsList.includes(inspectionItems[index].name) && val && val !== "✅ OK") criticalItems++;
            });
            
            const completionRate = Math.round((completedItems / totalItems) * 100);
            
            document.getElementById('dashboard-ok').textContent = okItems;
            document.getElementById('dashboard-problems').textContent = problemItems;
            document.getElementById('dashboard-critical').textContent = criticalItems;
            document.getElementById('dashboard-completion').textContent = `${completionRate}%`;
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Marcar formulário como modificado
        function marcarModificado() {
            dadosModificados = true;
        }
        
        // Confirmar saída do formulário
        function confirmExit(saveBeforeExit) {
            const modal = document.getElementById('exitConfirmation');
            modal.style.display = 'none';
            
            if (saveBeforeExit) {
                salvarDados().then(() => {
                    if (pendingExitAction) {
                        pendingExitAction();
                        pendingExitAction = null;
                    }
                });
            } else {
                if (pendingExitAction) {
                    pendingExitAction();
                    pendingExitAction = null;
                }
            }
        }
        
        function cancelExit() {
            const modal = document.getElementById('exitConfirmation');
            modal.style.display = 'none';
            pendingExitAction = null;
        }
        
        // Salvar dados
        async function salvarDados() {
            try {
                showLoading(true);
                const key = getStorageKey();
                if (!key) return false;
                
                const dados = {
                    hospital: document.getElementById("hospital").value,
                    data: document.getElementById("data").value,
                    horarioEntrada: document.getElementById("horarioEntrada").value,
                    horarioSaida: document.getElementById("horarioSaida").value,
                    condutorPlantao: document.getElementById("condutorPlantao").value,
                    recebendoDe: document.getElementById("recebendoDe").value,
                    placa: document.getElementById("placa").value,
                    kmAtual: document.getElementById("kmAtual").value,
                    nivelCombustivel: document.getElementById("nivelCombustivel").value,
                    crvValido: document.getElementById("crvValido").value,
                    proximaTrocaOleo: document.getElementById("proximaTrocaOleo").value,
                    ambulanciaStatus: document.querySelector('input[name="ambulanciaStatus"]:checked')?.value || '',
                    cartaoStatus: document.querySelector('input[name="cartaoStatus"]:checked')?.value || '',
                    observacoesAvarias: document.getElementById("observacoesAvarias").value,
                    coordenadasGPS: coordenadasGPS,
                    timestamp: new Date().toISOString(),
                    itens: []
                };
                
                for (let i = 1; i <= inspectionItems.length; i++) {
                    dados.itens.push({
                        status: document.getElementById(`status-${i}`).value,
                        obs: document.getElementById(`obs-${i}`).value
                    });
                }
                
                // Salvar no localStorage (compatibilidade)
                localStorage.setItem(key, JSON.stringify(dados));
                
                // Salvar no IndexedDB (melhor performance)
                if (db) {
                    await salvarDadosIndexedDB(dados, key);
                }
                
                lastSaveTime = new Date();
                dadosModificados = false;
                document.getElementById('saveIndicator').textContent = `Salvo: ${lastSaveTime.toLocaleTimeString()}`;
                
                // Se estiver online, tenta sincronizar com o servidor (simulado)
                if (isOnline) {
                    console.log('Sincronizando com o servidor...');
                    showNotification("Salvo localmente e sincronizado.", "success");
                } else {
                    // Adiciona à fila de sincronização
                    syncQueue.push({ action: 'save', key, data: dados });
                    pendingSync = true;
                    showNotification("Salvo localmente. Aguardando conexão para sincronizar.", "warning");
                }
                
                return true;
            } catch (e) {
                console.error("Erro ao salvar:", e);
                showNotification("Falha ao salvar.", "error");
                return false;
            } finally {
                showLoading(false);
            }
        }
        
        // Carregar dados
        async function carregarDados() {
            try {
                showLoading(true);
                const key = getStorageKey();
                if (!key) return false;
                
                let dados = null;
                
                // Tentar carregar do IndexedDB primeiro
                if (db) {
                    dados = await carregarDadosIndexedDB(key);
                }
                
                // Se não encontrou no IndexedDB, tentar do localStorage
                if (!dados) {
                    const dadosSalvos = localStorage.getItem(key);
                    if (dadosSalvos) {
                        dados = JSON.parse(dadosSalvos);
                    }
                }
                
                if (!dados) return false;
                
                // Preencher formulário
                document.getElementById("hospital").value = dados.hospital || '';
                document.getElementById("data").value = dados.data || '';
                document.getElementById("horarioEntrada").value = dados.horarioEntrada || '';
                document.getElementById("horarioSaida").value = dados.horarioSaida || '';
                document.getElementById("condutorPlantao").value = dados.condutorPlantao || '';
                document.getElementById("recebendoDe").value = dados.recebendoDe || '';
                document.getElementById("placa").value = dados.placa || '';
                document.getElementById("kmAtual").value = dados.kmAtual || '';
                document.getElementById("nivelCombustivel").value = dados.nivelCombustivel || '';
                document.getElementById("crvValido").value = dados.crvValido || '';
                document.getElementById("proximaTrocaOleo").value = dados.proximaTrocaOleo || '';
                document.getElementById("observacoesAvarias").value = dados.observacoesAvarias || '';
                
                if (dados.ambulanciaStatus) {
                    const radio = document.querySelector(`input[name="ambulanciaStatus"][value="${dados.ambulanciaStatus}"]`);
                    if (radio) radio.checked = true;
                }
                
                if (dados.cartaoStatus) {
                    const radio = document.querySelector(`input[name="cartaoStatus"][value="${dados.cartaoStatus}"]`);
                    if (radio) radio.checked = true;
                }
                
                if (dados.coordenadasGPS) {
                    coordenadasGPS = dados.coordenadasGPS;
                    const localizacaoElement = document.getElementById('localizacao');
                    localizacaoElement.innerHTML = 
                        `📍 Localização: ${dados.coordenadasGPS.latitude.toFixed(6)}, ${dados.coordenadasGPS.longitude.toFixed(6)} (${new Date(dados.coordenadasGPS.timestamp).toLocaleTimeString()}) 
                         <button onclick="mostrarLocalizacaoNoMapa()" class="btn-maps">Ver no Maps</button>`;
                }
                
                if (dados.itens && dados.itens.length === inspectionItems.length) {
                    for (let i = 0; i < dados.itens.length; i++) {
                        document.getElementById(`status-${i+1}`).value = dados.itens[i].status || '';
                        document.getElementById(`obs-${i+1}`).value = dados.itens[i].obs || '';
                    }
                }
                
                // Atualizar itens críticos baseado no tipo de ambulância
                const selectedAmbulance = document.querySelector('input[name="ambulanciaStatus"]:checked');
                if (selectedAmbulance) {
                    updateCriticalItems(selectedAmbulance.value);
                }
                
                updateStatusCounters();
                updateDashboard();
                dadosModificados = false;
                return true;
            } catch (e) {
                console.error("Erro ao carregar:", e);
                return false;
            } finally {
                showLoading(false);
            }
        }
        
        // Histórico
        async function abrirHistorico() {
            try {
                showLoading(true);
                const modal = document.getElementById('modalHistorico');
                const lista = document.getElementById('listaHistorico');
                lista.innerHTML = '';
                
                let historico = [];
                
                // Tentar obter do IndexedDB primeiro
                if (db) {
                    historico = await getHistoricoIndexedDB();
                }
                
                // Se não encontrou no IndexedDB, tentar do localStorage
                if (historico.length === 0) {
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('checklist_')) {
                            try { 
                                historico.push({ 
                                    key, 
                                    dados: JSON.parse(localStorage.getItem(key)) 
                                }); 
                            } catch (e) { 
                                console.error('Erro ao carregar histórico:', e); 
                            }
                        }
                    }
                    historico.sort((a, b) => new Date(b.dados.timestamp || 0) - new Date(a.dados.timestamp || 0));
                }
                
                if (historico.length === 0) {
                    lista.innerHTML = '<p>Nenhum check-list encontrado no histórico.</p>';
                } else {
                    historico.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'history-item';
                        div.innerHTML = `
                           <strong>VTR :</strong> ${item.dados.ambulanciaStatus || 'Não informado'}<br>
                            <strong>Placa:</strong> ${item.dados.placa}<br>
                            <strong>Data:</strong> ${item.dados.data}<br>
                            <strong>Condutor:</strong> ${item.dados.condutorPlantao}<br>
                            <small>Salvo em: ${new Date(item.dados.timestamp || 0).toLocaleString()}</small>
                        `;
                        div.onclick = () => carregarDoHistorico(item.key);
                        lista.appendChild(div);
                    });
                }
                
                modal.style.display = 'block';
            } catch (e) {
                console.error("Erro ao abrir histórico:", e);
                showNotification("Erro ao carregar histórico.", "error");
            } finally {
                showLoading(false);
            }
        }
        
        function carregarDoHistorico(key) {
            try {
                // Atualizar a chave de armazenamento
                const placa = document.getElementById("placa").value.trim().toUpperCase();
                const data = document.getElementById("data").value;
                const currentKey = placa && data ? `checklist_${placa}_${data}` : null;
                
                // Se a chave atual for diferente, precisamos atualizar os campos de placa e data
                if (currentKey !== key) {
                    const keyParts = key.split('_');
                    if (keyParts.length >= 3) {
                        document.getElementById("placa").value = keyParts[1];
                        document.getElementById("data").value = keyParts[2];
                    }
                }
                
                // Recarregar os dados com a nova chave
                carregarDados();
                fecharHistorico();
                showNotification("Check-list carregado do histórico!", "success");
            } catch (e) {
                showNotification("Erro ao carregar do histórico", "error");
            }
        }
        
        function fecharHistorico() { 
            document.getElementById('modalHistorico').style.display = 'none'; 
        }
        
        function validateForm() {
            const required = ["hospital", "data", "condutorPlantao", "placa", "kmAtual"];
            const today = new Date(); today.setHours(0,0,0,0);
            const dataInput = document.getElementById("data").value;
            const dataCheck = new Date(dataInput); dataCheck.setHours(0,0,0,0);
            if (dataCheck > today) { showNotification("A data não pode ser futura.", "error"); return false; }
            if (!validarPlaca()) { return false; }
            let isValid = true;
            document.querySelectorAll('.required-field').forEach(el => el.classList.remove('required-field'));
            required.forEach(id => {
                const el = document.getElementById(id);
                if (!el.value.trim()) { isValid = false; el.classList.add("required-field"); }
            });
            
            // Obter o tipo de ambulância selecionado
            const selectedAmbulance = document.querySelector('input[name="ambulanciaStatus"]:checked');
            const ambulanceType = selectedAmbulance ? selectedAmbulance.value : null;
            const criticalItemsList = ambulanceType ? criticalItemsByType[ambulanceType] : [];
            
            const criticalIssues = [];
            inspectionItems.forEach((item, index) => {
                if (criticalItemsList.includes(item.name)) {
                    const status = document.getElementById(`status-${index+1}`).value;
                    if (status && status !== "✅ OK") criticalIssues.push(item.name);
                }
            });
            if (criticalIssues.length > 0) {
                showNotification(`❗ Itens críticos com problemas: ${criticalIssues.slice(0, 3).join(", ")}${criticalIssues.length > 3 ? "..." : ""}`, "warning");
            }
            if (!isValid) { showNotification("Preencha os campos obrigatórios.", "error"); }
            return isValid;
        }
        
        function enviarPorEmail() {
            if (!validateForm()) return;
            const dataValue = document.getElementById("data").value;
            const [y, m, d] = dataValue.split('-');
            const dataFormatada = `${d}/${m}/${y}`;
            const dadosCabecalho = {
                hospital: document.getElementById("hospital").value,
                data: dataFormatada,
                horarioEntrada: document.getElementById("horarioEntrada").value,
                horarioSaida: document.getElementById("horarioSaida").value,
                condutorPlantao: document.getElementById("condutorPlantao").value,
                recebendoDe: document.getElementById("recebendoDe").value
            };
            const dadosViatura = {
                placa: document.getElementById("placa").value.toUpperCase(),
                kmAtual: document.getElementById("kmAtual").value,
                nivelCombustivel: document.getElementById("nivelCombustivel").value,
                crvValido: document.getElementById("crvValido").value,
                proximaTrocaOleo: document.getElementById("proximaTrocaOleo").value,
                ambulanciaStatus: document.querySelector('input[name="ambulanciaStatus"]:checked')?.value || 'Não informado',
                cartaoStatus: document.querySelector('input[name="cartaoStatus"]:checked')?.value || 'Não informado'
            };
            const itensInspecao = [];
            for (let i = 1; i <= inspectionItems.length; i++) {
                const status = document.getElementById(`status-${i}`).value;
                const obs = document.getElementById(`obs-${i}`).value.trim();
                if (status || obs) {
                    itensInspecao.push({
                        num: i.toString().padStart(2, '0'),
                        item: inspectionItems[i-1].name,
                        status: status || 'Não avaliado',
                        obs: obs || '---'
                    });
                }
            }
            if (itensInspecao.length === 0) {
                showNotification("Preencha ao menos um item de inspeção.", "warning");
                return;
            }
            const observacoesGerais = document.getElementById("observacoesAvarias").value;
            
            // Gerar link do Google Maps se houver coordenadas
            let localizacaoInfo = 'Localização não disponível';
            if (coordenadasGPS && coordenadasGPS.latitude && coordenadasGPS.longitude) {
                const lat = coordenadasGPS.latitude.toFixed(6);
                const lon = coordenadasGPS.longitude.toFixed(6);
                const googleMapsLink = `https://maps.google.com/?q=${lat},${lon}`;
                localizacaoInfo = `LOCALIZAÇÃO: ${lat}, ${lon}\nGoogle Maps: ${googleMapsLink}`;
            }
            
            // Agrupar itens por status para melhor visualização
            const itensAgrupados = {
                '✅ OK': [],
                '⚠️ Ruim': [],
                '🛠️ Quebrado': [],
                '❌ Faltando': [],
                '🚨 Parar VTR': []
            };
            
            itensInspecao.forEach(item => {
                if (itensAgrupados[item.status]) {
                    itensAgrupados[item.status].push(item);
                }
            });
            
            const corpoEmail = `
==============================================================================
                            CHECK-LIST DIÁRIO - LEFE
==============================================================================
                                VIATURA: ${dadosViatura.placa}
                                VTR: ${dadosViatura.ambulanciaStatus}
                                DATA: ${dadosCabecalho.data}
==============================================================================
INFORMAÇÕES BÁSICAS
==============================================================================
Hospital: ${dadosCabecalho.hospital}
Condutor de Plantão: ${dadosCabecalho.condutorPlantao}
Recebendo de: ${dadosCabecalho.recebendoDe}
Horário de Entrada: ${dadosCabecalho.horarioEntrada}
Horário de Saída: ${dadosCabecalho.horarioSaida}
Localização: ${localizacaoInfo}
DADOS DA VIATURA
==============================================================================
VTRT: ${dadosViatura.ambulanciaStatus}
Placa: ${dadosViatura.placa}
Km Atual: ${dadosViatura.kmAtual} km
Nível de Combustível: ${dadosViatura.nivelCombustivel}
CRV Válido até: ${dadosViatura.crvValido}
Próxima Troca de Óleo: ${dadosViatura.proximaTrocaOleo} km
Cartão de Abastecimento: ${dadosViatura.cartaoStatus}
ITENS DE INSPEÇÃO
==============================================================================
ITENS COM STATUS ✅ OK (${itensAgrupados['✅ OK'].length} itens)
${itensAgrupados['✅ OK'].map(item => `• ${item.num}. ${item.item}`).join('\n')}
${itensAgrupados['⚠️ Ruim'].length > 0 ? `
ITENS COM STATUS ⚠️ RUIM (${itensAgrupados['⚠️ Ruim'].length} itens)
${itensAgrupados['⚠️ Ruim'].map(item => `• ${item.num}. ${item.item} - Obs: ${item.obs}`).join('\n')}
` : ''}
${itensAgrupados['🛠️ Quebrado'].length > 0 ? `
ITENS COM STATUS 🛠️ QUEBRADO (${itensAgrupados['🛠️ Quebrado'].length} itens)
${itensAgrupados['🛠️ Quebrado'].map(item => `• ${item.num}. ${item.item} - Obs: ${item.obs}`).join('\n')}
` : ''}
${itensAgrupados['❌ Faltando'].length > 0 ? `
ITENS COM STATUS ❌ FALTANDO (${itensAgrupados['❌ Faltando'].length} itens)
${itensAgrupados['❌ Faltando'].map(item => `• ${item.num}. ${item.item} - Obs: ${item.obs}`).join('\n')}
` : ''}
${itensAgrupados['🚨 Parar VTR'].length > 0 ? `
ITENS COM STATUS 🚨 PARAR VTR (${itensAgrupados['🚨 Parar VTR'].length} itens)
${itensAgrupados['🚨 Parar VTR'].map(item => `• ${item.num}. ${item.item} - Obs: ${item.obs}`).join('\n')}
` : ''}
${observacoesGerais ? `
OBSERVAÇÕES GERAIS / AVARIAS
==============================================================================
${observacoesGerais}
` : ''}
================================================================================
E-mail gerado automaticamente pelo sistema LEFE em ${new Date().toLocaleString()}
==============================================================================`.trim();
            const assunto = `Check-list Viatura ${dadosViatura.placa} - ${dadosCabecalho.data}`;
            // Correção: E-mail destinatário correto
            const destinatario = "lefechecklist@gmail.com";
            const mailtoLink = `mailto:${destinatario}?subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpoEmail)}`;
            window.location.href = mailtoLink;
            showNotification("Abrindo e-mail...", "success");
        }
        
        // Função para detectar se está em um WebView
        function isWebView() {
            const userAgent = navigator.userAgent.toLowerCase();
            return userAgent.includes('android') && userAgent.includes('wv') || 
                   userAgent.includes('iphone') && userAgent.includes('webview');
        }
        
        // Função para enviar por WhatsApp com fallback
        function enviarPorWhatsApp() {
            if (!validateForm()) return;
            
            const dataValue = document.getElementById("data").value;
            const [y, m, d] = dataValue.split('-');
            const dataFormatada = `${d}/${m}/${y}`;
            
            const dadosCabecalho = {
                hospital: document.getElementById("hospital").value,
                data: dataFormatada,
                condutorPlantao: document.getElementById("condutorPlantao").value,
                recebendoDe: document.getElementById("recebendoDe").value,
                placa: document.getElementById("placa").value.toUpperCase(),
                ambulanciaStatus: document.querySelector('input[name="ambulanciaStatus"]:checked')?.value || 'Não informado'
            };
            
            // Obter horários
            const horarioEntrada = document.getElementById("horarioEntrada").value;
            const horarioSaida = document.getElementById("horarioSaida").value;
            
            // Gerar link do Google Maps se houver coordenadas
            let localizacaoInfo = 'Localização não disponível';
            if (coordenadasGPS && coordenadasGPS.latitude && coordenadasGPS.longitude) {
                const lat = coordenadasGPS.latitude.toFixed(6);
                const lon = coordenadasGPS.longitude.toFixed(6);
                const googleMapsLink = `https://maps.google.com/?q=${lat},${lon}`;
                localizacaoInfo = ` ${lat}, ${lon}\n*Google Maps:* ${googleMapsLink}`;
            }
            
            const itensInspecao = [];
            for (let i = 1; i <= inspectionItems.length; i++) {
                const status = document.getElementById(`status-${i}`).value;
                const obs = document.getElementById(`obs-${i}`).value.trim();
                if (status || obs) {
                    itensInspecao.push({
                        num: i.toString().padStart(2, '0'),
                        item: inspectionItems[i-1].name,
                        status: status || 'Não avaliado',
                        obs: obs || '---'
                    });
                }
            }
            
            if (itensInspecao.length === 0) {
                showNotification("Preencha ao menos um item de inspeção.", "warning");
                return;
            }
            
            const observacoesGerais = document.getElementById("observacoesAvarias").value;
            
            // Formatar a mensagem para WhatsApp
            let mensagem = `📋 *CHECK-LIST DIÁRIO - LEFE*\n\n`;
            mensagem += `🏥 *Hospital:* ${dadosCabecalho.hospital}\n`;
            mensagem += `📆 *Data:* ${dadosCabecalho.data}\n`;
            mensagem += `*🚑 Placa:* ${dadosCabecalho.placa}\n`;
            mensagem += `🚑 *VTR:* ${dadosCabecalho.ambulanciaStatus}\n\n`;
            mensagem += `🙋🏻 *Condutor:* ${dadosCabecalho.condutorPlantao}\n`;
            
            // Adicionando o campo "Recebendo de"
            if (dadosCabecalho.recebendoDe) {
                mensagem += `🫂 *Recebendo de:* ${dadosCabecalho.recebendoDe}\n`;
            }
            
            // Adicionando horários
            mensagem += `⏰ *Horário Entrada:* ${horarioEntrada}\n`;
            mensagem += `⏰ *Horário Saída:* ${horarioSaida}\n`;
            
            // Adicionando localização
            mensagem += `📍 *Localização:* ${localizacaoInfo}\n\n`;
            
            mensagem += `📝 *ITENS DE INSPEÇÃO:*\n\n`;
            itensInspecao.forEach(item => {
                mensagem += `${item.num}. ${item.item}`;
                mensagem += `: ${item.status}`;
                if (item.obs !== '---') {
                    mensagem += `   Obs: ${item.obs}\n`;
                }
                mensagem += `\n`;
            });
            
            if (observacoesGerais) {
                mensagem += `\n 🛠️ *OBSERVAÇÕES GERAIS / AVARIAS:*\n${observacoesGerais}\n\n`;
            }
            
            mensagem += `🙏🏻 *Deus seja louvado!!!*`;
            
            // Armazenar mensagem atual para uso posterior
            mensagemWhatsAppAtual = mensagem;
            
            // Codificar a mensagem para URL
            const mensagemCodificada = encodeURIComponent(mensagem);
            
            // Verificar se é um dispositivo móvel
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            // Verificar se estamos em um WebView (dentro de um aplicativo)
            const webView = isWebView();
            
            if (webView) {
                // Estamos em um WebView, mostrar alternativas
                mostrarModalWhatsApp();
                showNotification("Abrindo alternativas para WhatsApp...", "info");
            } else if (isMobile) {
                // Para dispositivos móveis nativos, tentar abrir o aplicativo WhatsApp
                const whatsappAppUrl = `whatsapp://send?text=${mensagemCodificada}`;
                
                // Tentar abrir o app
                const timeoutId = setTimeout(() => {
                    // Se o app não abrir em 500ms, mostrar alternativas
                    mostrarModalWhatsApp();
                }, 500);
                
                // Tentar abrir o app
                window.location.href = whatsappAppUrl;
                
                // Se o app abrir, cancelar o timeout
                window.addEventListener('blur', () => {
                    clearTimeout(timeoutId);
                }, { once: true });
                
                showNotification("Tentando abrir o WhatsApp...", "success");
            } else {
                // Para desktop, abrir a web version
                const whatsappWebUrl = `https://web.whatsapp.com/send?text=${mensagemCodificada}`;
                window.open(whatsappWebUrl, '_blank');
                showNotification("Abrindo WhatsApp Web...", "success");
            }
        }
        
        // Função para mostrar o modal de alternativas do WhatsApp
        function mostrarModalWhatsApp() {
            const modal = document.getElementById('modalWhatsApp');
            const preview = document.getElementById('mensagemWhatsAppPreview');
            
            // Exibir a mensagem no preview
            preview.textContent = mensagemWhatsAppAtual;
            
            // Mostrar o modal
            modal.style.display = 'block';
            
            showNotification("Não foi possível abrir o WhatsApp. Escolha uma alternativa.", "warning");
        }
        
        // Função para fechar o modal de alternativas do WhatsApp
        function fecharModalWhatsApp() {
            document.getElementById('modalWhatsApp').style.display = 'none';
        }
        
        // Função para abrir o WhatsApp Web
        function abrirWhatsAppWeb() {
            const mensagemCodificada = encodeURIComponent(mensagemWhatsAppAtual);
            const whatsappWebUrl = `https://web.whatsapp.com/send?text=${mensagemCodificada}`;
            window.open(whatsappWebUrl, '_blank');
            fecharModalWhatsApp();
            showNotification("Abrindo WhatsApp Web...", "success");
        }
        
        // Função para copiar a mensagem para a área de transferência
        function copiarMensagemWhatsApp() {
            // Criar um elemento textarea temporário
            const textarea = document.createElement('textarea');
            textarea.value = mensagemWhatsAppAtual;
            document.body.appendChild(textarea);
            
            // Selecionar e copiar o texto
            textarea.select();
            document.execCommand('copy');
            
            // Remover o elemento temporário
            document.body.removeChild(textarea);
            
            fecharModalWhatsApp();
            showNotification("Mensagem copiada para a área de transferência!", "success");
        }
        
        function limparFormulario() {
            if (confirm("Deseja realmente limpar todos os campos?")) {
                const key = getStorageKey();
                if (key) { 
                    localStorage.removeItem(key);
                    if (db) {
                        const transaction = db.transaction(['checklists'], 'readwrite');
                        const objectStore = transaction.objectStore('checklists');
                        objectStore.delete(key);
                    }
                }
                document.querySelectorAll('.item-selector').forEach(cb => { cb.checked = false; });
                dadosModificados = false;
                location.reload();
            }
        }
        
        function showNotification(message, type) {
            const notification = document.getElementById("notification");
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = "block";
            setTimeout(() => notification.style.display = "none", 6000);
        }
        
        function showLoading(show) {
            const indicator = document.getElementById('loadingIndicator');
            if (show) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        }
        
        // Busca/filtro
        function filtrarItens() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#inspection-table tbody tr');
            filteredItems = [];
            rows.forEach((row, index) => {
                const itemName = inspectionItems[index]?.name?.toLowerCase?.() || '';
                const status = (row.querySelector('.status-select')?.value || '').toLowerCase();
                const obs = (row.querySelector('.obs-input')?.value || '').toLowerCase();
                if (itemName.includes(term) || status.includes(term) || obs.includes(term)) {
                    row.style.display = '';
                    if (!filteredItems.includes(inspectionItems[index])) {
                        filteredItems.push(inspectionItems[index]);
                    }
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Edição em lote
        function toggleBatchEdit() {
            const el = document.getElementById('batchEdit');
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
        }
        
        function toggleSelectAll(checkbox) {
            document.querySelectorAll('.item-selector').forEach(cb => { cb.checked = checkbox.checked; });
        }
        
        function selecionarTodosItens() {
            document.querySelectorAll('.item-selector').forEach(cb => { cb.checked = true; });
        }
        
        function desselecionarTodosItens() {
            document.querySelectorAll('.item-selector').forEach(cb => { cb.checked = false; });
        }
        
        function aplicarEdicaoEmLote() {
            const status = document.getElementById('batchStatus').value;
            if (!status) return showNotification("Selecione um status para aplicar", "error");
            const cbs = document.querySelectorAll('.item-selector:checked');
            if (cbs.length === 0) return showNotification("Selecione pelo menos um item", "error");
            cbs.forEach(cb => {
                const id = cb.getAttribute('data-id');
                document.getElementById(`status-${id}`).value = status;
            });
            updateStatusCounters(); updateDashboard(); marcarModificado();
            showNotification(`Status aplicado a ${cbs.length} itens`, "success");
        }
        
        // Atalhos
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 's') { e.preventDefault(); salvarDados(); }
                if (e.ctrlKey && e.key === 'e') { e.preventDefault(); enviarPorEmail(); }
                if (e.ctrlKey && e.key === 'w') { e.preventDefault(); enviarPorWhatsApp(); }
                if (e.ctrlKey && e.key === 'p') { e.preventDefault(); window.print(); }
                if (e.ctrlKey && e.key === 'f') { e.preventDefault(); document.getElementById('searchInput').focus(); }
                if (e.ctrlKey && e.key.toLowerCase() === 'b') { e.preventDefault(); toggleToolbar(); }
                if (e.ctrlKey && e.key.toLowerCase() === 'd') { e.preventDefault(); toggleDetailsSections(); }
                if (e.key === 'Escape') { 
                    fecharHistorico(); 
                    fecharBackup(); 
                    fecharRelatorioTendencia(); 
                    fecharModalWhatsApp();
                }
                if (e.ctrlKey && e.key === '/') {
                    e.preventDefault();
                    document.getElementById('keyboardShortcuts').classList.toggle('show');
                }
            });
        }
        
        // Função para ocultar/mostrar a coluna de observação
        function toggleObservationColumn(hide) {
            const table = document.getElementById('inspection-table');
            if (!table) return;
            
            // Ocultar/mostrar cabeçalho da coluna de observação (5ª coluna)
            const headerCells = table.querySelectorAll('thead th');
            if (headerCells.length >= 5) {
                headerCells[4].style.display = hide ? 'none' : '';
            }
            
            // Ocultar/mostrar células de observação no corpo da tabela (5ª coluna)
            const bodyRows = table.querySelectorAll('tbody tr');
            bodyRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    cells[4].style.display = hide ? 'none' : '';
                }
            });
        }
        
        // Função para alternar a visibilidade das seções de detalhes
        function toggleDetailsSections() {
            const detailsSections = document.querySelectorAll('.details-section');
            const dashboard = document.querySelector('.dashboard');
            const statusCounters = document.querySelector('.status-counters');
            const btnText = document.getElementById('btnToggleDetailsText');
            
            const areHidden = detailsSections.length > 0 && detailsSections[0].classList.contains('details-hidden');
            
            detailsSections.forEach(section => {
                section.classList.toggle('details-hidden');
            });
            
            if (dashboard) {
                dashboard.classList.toggle('details-hidden');
            }
            
            if (statusCounters) {
                statusCounters.classList.toggle('details-hidden');
            }
            
            // Adicionar esta linha para ocultar/mostrar a coluna de observação
            toggleObservationColumn(!areHidden);
            
            if (areHidden) {
                btnText.textContent = 'Ocultar Detalhes';
                localStorage.setItem(DETAILS_HIDDEN_KEY, 'false');
            } else {
                btnText.textContent = 'Mostrar Detalhes';
                localStorage.setItem(DETAILS_HIDDEN_KEY, 'true');
            }
        }
        
        // Backup (apenas chaves checklist_)
        function fazerBackup() {
            showLoading(true);
            
            const backupData = {};
            
            // Tentar obter dados do IndexedDB primeiro
            if (db) {
                const transaction = db.transaction(['checklists'], 'readonly');
                const objectStore = transaction.objectStore('checklists');
                
                const request = objectStore.openCursor();
                
                request.onsuccess = function(event) {
                    const cursor = event.target.result;
                    if (cursor) {
                        backupData[cursor.value.id] = cursor.value.dados;
                        cursor.continue();
                    } else {
                        // Se não encontrou nada no IndexedDB, tentar do localStorage
                        if (Object.keys(backupData).length === 0) {
                            for (let i = 0; i < localStorage.length; i++) {
                                const key = localStorage.key(i);
                                if (key.startsWith('checklist_')) {
                                    backupData[key] = JSON.parse(localStorage.getItem(key));
                                }
                            }
                        }
                        
                        // Criar e baixar o arquivo de backup
                        const dataStr = JSON.stringify(backupData);
                        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                        const exportFileDefaultName = `lefe_backup_${new Date().toISOString().split('T')[0]}.json`;
                        const linkElement = document.createElement('a');
                        linkElement.setAttribute('href', dataUri);
                        linkElement.setAttribute('download', exportFileDefaultName);
                        linkElement.click();
                        
                        showNotification("Backup criado com sucesso!", "success");
                        showLoading(false);
                    }
                };
                
                request.onerror = function(event) {
                    console.error('Erro ao criar backup:', event.target.error);
                    showNotification("Erro ao criar backup.", "error");
                    showLoading(false);
                };
            } else {
                // Se não há IndexedDB, usar apenas localStorage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('checklist_')) {
                        backupData[key] = JSON.parse(localStorage.getItem(key));
                    }
                }
                
                const dataStr = JSON.stringify(backupData);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = `lefe_backup_${new Date().toISOString().split('T')[0]}.json`;
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showNotification("Backup criado com sucesso!", "success");
                showLoading(false);
            }
        }
        
        function restaurarBackup() {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        showLoading(true);
                        const backupData = JSON.parse(e.target.result);
                        
                        // Limpar dados existentes
                        const keysToRemove = [];
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('checklist_')) keysToRemove.push(key);
                        }
                        keysToRemove.forEach(k => localStorage.removeItem(k));
                        
                        // Limpar IndexedDB se disponível
                        if (db) {
                            const transaction = db.transaction(['checklists'], 'readwrite');
                            const objectStore = transaction.objectStore('checklists');
                            objectStore.clear();
                        }
                        
                        // Restaurar dados
                        Object.keys(backupData).forEach(key => { 
                            localStorage.setItem(key, JSON.stringify(backupData[key]));
                            
                            // Restaurar no IndexedDB se disponível
                            if (db) {
                                salvarDadosIndexedDB(backupData[key], key);
                            }
                        });
                        
                        showNotification("Backup restaurado com sucesso! Recarregando...", "success");
                        setTimeout(() => location.reload(), 2000);
                    } catch (error) {
                        console.error("Erro ao restaurar backup:", error);
                        showNotification("Erro ao restaurar backup: arquivo inválido", "error");
                        showLoading(false);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function abrirBackup() { 
            document.getElementById('modalBackup').style.display = 'block'; 
        }
        
        function fecharBackup() { 
            document.getElementById('modalBackup').style.display = 'none'; 
        }
        
        // Preview de fotos gerais
        function setupFotosGeraisPreview() {
            const input = document.getElementById('fotosGerais');
            const preview = document.getElementById('previewFotosGerais');
            if (!input || !preview) return;
            input.addEventListener('change', () => {
                preview.innerHTML = '';
                const files = Array.from(input.files || []);
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        const img = document.createElement('img');
                        img.src = ev.target.result;
                        img.className = 'photo-preview';
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                });
            });
        }
        
        // Relatório de Tendência
        async function abrirRelatorioTendencia() {
            try {
                showLoading(true);
                const modal = document.getElementById('modalTendencia');
                const conteudo = document.getElementById('conteudoRelatorioTendencia');
                
                // Obter todos os check-lists
                let allChecklists = [];
                
                // Tentar obter do IndexedDB primeiro
                if (db) {
                    const transaction = db.transaction(['checklists'], 'readonly');
                    const objectStore = transaction.objectStore('checklists');
                    
                    return new Promise((resolve, reject) => {
                        const request = objectStore.openCursor();
                        
                        request.onsuccess = function(event) {
                            const cursor = event.target.result;
                            if (cursor) {
                                allChecklists.push(cursor.value.dados);
                                cursor.continue();
                            } else {
                                // Se não encontrou nada no IndexedDB, tentar do localStorage
                                if (allChecklists.length === 0) {
                                    for (let i = 0; i < localStorage.length; i++) {
                                        const key = localStorage.key(i);
                                        if (key.startsWith('checklist_')) {
                                            try {
                                                const checklist = JSON.parse(localStorage.getItem(key));
                                                allChecklists.push(checklist);
                                            } catch (e) {
                                                console.error('Erro ao parsear checklist:', e);
                                            }
                                        }
                                    }
                                }
                                
                                // Processar dados e gerar relatório
                                processarRelatorioTendencia(allChecklists, conteudo);
                                modal.style.display = 'block';
                                showLoading(false);
                            }
                        };
                        
                        request.onerror = function(event) {
                            console.error('Erro ao obter dados para relatório:', event.target.error);
                            conteudo.innerHTML = '<p>Erro ao carregar dados para o relatório.</p>';
                            modal.style.display = 'block';
                            showLoading(false);
                        };
                    });
                } else {
                    // Se não há IndexedDB, usar apenas localStorage
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('checklist_')) {
                            try {
                                const checklist = JSON.parse(localStorage.getItem(key));
                                allChecklists.push(checklist);
                            } catch (e) {
                                console.error('Erro ao parsear checklist:', e);
                            }
                        }
                    }
                    
                    processarRelatorioTendencia(allChecklists, conteudo);
                    modal.style.display = 'block';
                    showLoading(false);
                }
            } catch (e) {
                console.error("Erro ao abrir relatório de tendência:", e);
                showNotification("Erro ao gerar relatório de tendência.", "error");
                showLoading(false);
            }
        }
        
        function processarRelatorioTendencia(allChecklists, conteudoElement) {
            // Contar problemas por item
            const problemasPorItem = {};
            allChecklists.forEach(checklist => {
                if (checklist.itens) {
                    checklist.itens.forEach((item, index) => {
                        const itemName = inspectionItems[index].name;
                        if (!problemasPorItem[itemName]) {
                            problemasPorItem[itemName] = 0;
                        }
                        if (item.status && item.status !== "✅ OK") {
                            problemasPorItem[itemName]++;
                        }
                    });
                }
            });
            
            // Ordenar itens por quantidade de problemas
            const itensOrdenados = Object.entries(problemasPorItem)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Gerar HTML do relatório
            if (itensOrdenados.length === 0) {
                conteudoElement.innerHTML = '<p>Nenhum problema encontrado no histórico.</p>';
            } else {
                let html = '<h3>Top 10 Itens com Mais Problemas</h3>';
                html += '<div class="trend-list">';
                
                // Encontrar o valor máximo para normalizar as barras
                const maxProblemas = Math.max(...itensOrdenados.map(item => item[1]));
                
                itensOrdenados.forEach(([item, count]) => {
                    const percentage = Math.round((count / maxProblemas) * 100);
                    
                    // Adicionar cores diferentes conforme a gravidade
                    let barColor = '#ff9800';
                    if (count > maxProblemas * 0.7) barColor = '#f44336';
                    else if (count < maxProblemas * 0.3) barColor = '#4CAF50';
                    
                    html += `
                        <div class="trend-item">
                            <div style="flex: 1;">${item}</div>
                            <div style="flex: 1;">
                                <div class="trend-bar" style="width: ${percentage}%; background-color: ${barColor};"></div>
                                <div style="text-align: right; margin-top: 5px;">${count} ocorrências (${percentage}%)</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // Adicionar seção de recomendações
                html += '<h3>Recomendações</h3>';
                html += '<ul>';
                html += '<li>Considere agendar manutenção preventiva para os itens com mais ocorrências de problemas</li>';
                html += '<li>Verifique se há padrões recorrentes que possam indicar problemas sistêmicos</li>';
                html += '<li>Priorize a correção dos itens críticos que aparecem na lista</li>';
                html += '</ul>';
                
                conteudoElement.innerHTML = html;
            }
        }
        
        function fecharRelatorioTendencia() {
            document.getElementById('modalTendencia').style.display = 'none';
        }
        
        // Gerenciar status de conexão
        function updateConnectionStatus() {
            const indicator = document.getElementById('offlineIndicator');
            if (isOnline) {
                indicator.classList.remove('show');
                // Se há pendências de sincronização, processar
                if (pendingSync && syncQueue.length > 0) {
                    processSyncQueue();
                }
            } else {
                indicator.classList.add('show');
            }
        }
        
        // Processar fila de sincronização
        function processSyncQueue() {
            if (syncQueue.length === 0) {
                pendingSync = false;
                return;
            }
            
            showNotification(`Sincronizando ${syncQueue.length} alterações...`, "info");
            
            // Processa cada item da fila com tentativas múltiplas
            const itemsToProcess = [...syncQueue];
            syncQueue = [];
            
            let successCount = 0;
            let failCount = 0;
            
            itemsToProcess.forEach((item, index) => {
                // Simulação de requisição com 80% de sucesso
                setTimeout(() => {
                    if (Math.random() < 0.8) {
                        successCount++;
                        console.log('Sincronizado com sucesso:', item);
                    } else {
                        failCount++;
                        // Readiciona na fila para tentar novamente depois
                        syncQueue.push(item);
                        console.log('Falha na sincronização:', item);
                    }
                    
                    // Notifica o usuário quando todas as tentativas forem concluídas
                    if (index === itemsToProcess.length - 1) {
                        if (failCount === 0) {
                            showNotification("Sincronização concluída com sucesso!", "success");
                        } else {
                            showNotification(`${successCount} itens sincronizados. ${failCount} falharam e serão tentados novamente.`, "warning");
                            pendingSync = syncQueue.length > 0;
                        }
                    }
                }, 1000 * (index + 1));
            });
        }
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar IndexedDB
            initIndexedDB();
            
            // Preferência da toolbar (oculta por padrão)
            const toolbarPref = localStorage.getItem(TOOLBAR_HIDDEN_KEY);
            if (toolbarPref === null) {
                toggleToolbar(true);
            } else {
                toggleToolbar(toolbarPref === '1');
            }
            
            verificarPrimeiraVisita();
            
            document.getElementById("data").value = new Date().toISOString().split("T")[0];
            generateInspectionTable();
            obterLocalizacao();
            carregarDados();
            setupKeyboardShortcuts();
            setupFotosGeraisPreview();
            
            // Configurar detecção de status online/offline
            window.addEventListener('online', () => {
                isOnline = true;
                updateConnectionStatus();
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateConnectionStatus();
            });
            
            // Verificar status inicial
            updateConnectionStatus();
            
            autoSaveInterval = setInterval(salvarDados, 30000);
            
            // Adicionar confirmação ao sair com alterações não salvas
            window.addEventListener('beforeunload', function(e) {
                if (dadosModificados) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                }
            });
            
            // Adicionar evento de mudança nos radio buttons do tipo de ambulância
            const radios = document.querySelectorAll('input[name="ambulanciaStatus"]');
            radios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        updateCriticalItems(this.value);
                        marcarModificado();
                    }
                });
            });
            
            document.getElementById("placa").addEventListener("change", carregarDados);
            document.getElementById("data").addEventListener("change", carregarDados);
            
            // Fechar modais clicando fora
            window.onclick = function(event) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            };
            
            // Service Worker para PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker
                    .register('service-worker.js')
                    .then(() => console.log("✅ Service Worker registrado com sucesso"))
                    .catch(err => console.error("Erro ao registrar Service Worker:", err));
            }
        });
    </script>
</body>
</html>
